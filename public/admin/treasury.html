<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tesorería y Cuentas | PixelTech Admin</title>
    <link rel="stylesheet" href="../css/styles.css">
    <script src="https://kit.fontawesome.com/0d623ded97.js" crossorigin="anonymous"></script>
    <style> 
        .hidden { display: none !important; } 
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #CBD5E1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 font-sans text-brand-black flex h-screen overflow-hidden">

    <div id="admin-sidebar"></div>

    <main class="flex-grow overflow-y-auto p-8 custom-scroll">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-black uppercase tracking-tighter">Tesorería</h1>
                <p class="text-xs font-bold text-gray-400 uppercase tracking-widest">Gestión de Pasarelas, Bancos y Efectivo</p>
            </div>
            <div class="flex gap-3">
                <button onclick="openTransferModal()" class="bg-white border border-gray-200 text-brand-black px-6 py-3 rounded-xl font-black text-[10px] uppercase tracking-widest hover:bg-slate-50 transition shadow-sm flex items-center gap-2">
                    <i class="fa-solid fa-money-bill-transfer"></i> Transferir Saldos
                </button>
                <button onclick="openAccountModal()" class="bg-brand-black text-white px-6 py-3 rounded-xl font-black text-[10px] uppercase tracking-widest hover:bg-brand-cyan hover:text-brand-black transition shadow-lg flex items-center gap-2">
                    <i class="fa-solid fa-plus"></i> Nueva Cuenta
                </button>
            </div>
        </header>

        <div id="accounts-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="col-span-3 text-center py-12">
                <i class="fa-solid fa-circle-notch fa-spin text-brand-cyan text-3xl"></i>
            </div>
        </div>
    </main>

    <div id="account-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-md" onclick="closeModal('account-modal')"></div>
        <div class="relative bg-white w-full max-w-md rounded-[2rem] shadow-2xl p-8 animate-in fade-in zoom-in-95 duration-200 overflow-y-auto max-h-[90vh] custom-scroll">
            <h3 class="text-xl font-black uppercase mb-6" id="modal-title">Datos de <span class="text-brand-cyan">Cuenta</span></h3>
            
            <form id="account-form" class="space-y-4">
                <input type="hidden" id="edit-id">
                
                <div>
                    <label class="text-[9px] font-black text-gray-400 uppercase tracking-widest block mb-1">Nombre Identificador *</label>
                    <input type="text" id="acc-name" required placeholder="Ej: PayU Latam" class="w-full bg-slate-50 border border-gray-200 p-3 rounded-xl font-bold text-sm outline-none focus:border-brand-cyan transition-all">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[9px] font-black text-gray-400 uppercase tracking-widest block mb-1">Tipo *</label>
                        <select id="acc-type" class="w-full bg-slate-50 border border-gray-200 p-3 rounded-xl font-bold text-sm outline-none focus:border-brand-cyan cursor-pointer transition-all">
                            <option value="banco">Banco Tradicional</option>
                            <option value="plataforma">Pasarela / Plataforma</option>
                            <option value="efectivo">Efectivo / Caja</option>
                        </select>
                    </div>
                    <div>
                        <label id="lbl-balance" class="text-[9px] font-black text-gray-400 uppercase tracking-widest block mb-1">Saldo Inicial *</label>
                        <input type="number" id="acc-balance" required value="0" class="w-full bg-slate-50 border border-gray-200 p-3 rounded-xl font-bold text-sm outline-none focus:border-brand-cyan transition-all">
                    </div>
                </div>

                <div id="bank-fields" class="hidden grid grid-cols-2 gap-4 p-4 bg-blue-50/50 rounded-xl border border-blue-100">
                    <div class="col-span-2"><span class="text-[9px] font-black text-blue-400 uppercase tracking-widest">Datos Bancarios</span></div>
                    <div class="col-span-2">
                        <label class="text-[9px] font-black text-gray-400 uppercase tracking-widest block mb-1">Número de Cuenta</label>
                        <input type="text" id="acc-number" placeholder="Ej: 987-0000-123" class="w-full bg-white border border-gray-200 p-3 rounded-xl font-bold text-sm outline-none focus:border-brand-cyan">
                    </div>
                    <div class="col-span-2">
                        <label class="text-[9px] font-black text-gray-400 uppercase tracking-widest block mb-1">Tipo de Cuenta</label>
                        <div class="flex gap-4 mt-1">
                            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="bankType" value="Ahorros" checked class="accent-brand-cyan"><span class="text-xs font-bold text-gray-600">Ahorros</span></label>
                            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="bankType" value="Corriente" class="accent-brand-cyan"><span class="text-xs font-bold text-gray-600">Corriente</span></label>
                        </div>
                    </div>
                </div>

                <div id="platform-fields" class="hidden grid grid-cols-2 gap-4 p-4 bg-purple-50/50 rounded-xl border border-purple-100">
                    <div class="col-span-2"><span class="text-[9px] font-black text-purple-400 uppercase tracking-widest">Configuración de Comisiones</span></div>
                    
                    <div class="col-span-2">
                        <label class="text-[9px] font-black text-gray-400 uppercase tracking-widest block mb-1">Tipo de Comisión</label>
                        <select id="fee-type" class="w-full bg-white border border-gray-200 p-2 rounded-xl font-bold text-xs outline-none focus:border-brand-cyan">
                            <option value="variable">Variable (% + Fijo)</option>
                            <option value="fixed">Solo Fija ($)</option>
                        </select>
                    </div>

                    <div id="fee-var-group" class="contents">
                        <div>
                            <label class="text-[9px] font-black text-gray-400 uppercase tracking-widest block mb-1">Porcentaje (%)</label>
                            <input type="number" id="fee-percent" step="0.01" placeholder="Ej: 3.49" class="w-full bg-white border border-gray-200 p-3 rounded-xl font-bold text-sm outline-none focus:border-brand-cyan text-center">
                        </div>
                    </div>
                    
                    <div id="fee-fixed-container">
                        <label class="text-[9px] font-black text-gray-400 uppercase tracking-widest block mb-1">Valor Fijo ($)</label>
                        <input type="number" id="fee-fixed" placeholder="Ej: 900" class="w-full bg-white border border-gray-200 p-3 rounded-xl font-bold text-sm outline-none focus:border-brand-cyan text-center">
                    </div>
                </div>

                <div class="space-y-2 pt-2">
                    <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl border border-gray-200 cursor-pointer hover:bg-slate-100 transition" onclick="document.getElementById('acc-exempt').click()">
                        <input type="checkbox" id="acc-exempt" class="w-5 h-5 accent-brand-cyan cursor-pointer">
                        <div>
                            <p class="text-xs font-bold text-brand-black uppercase">Exenta del 4x1000</p>
                            <p class="text-[8px] text-gray-400 uppercase">Si marcas esto, no se cobrará impuesto en salidas.</p>
                        </div>
                    </div>

                    <div class="flex items-center gap-3 p-3 bg-cyan-50 rounded-xl border border-cyan-100 cursor-pointer hover:bg-cyan-100 transition" onclick="document.getElementById('acc-online-default').click()">
                        <input type="checkbox" id="acc-online-default" class="w-5 h-5 accent-brand-cyan cursor-pointer">
                        <div>
                            <p class="text-xs font-bold text-brand-black uppercase">Vincular a Tienda Online</p>
                            <p class="text-[8px] text-gray-500 uppercase">Los pagos automáticos entrarán a esta cuenta.</p>
                        </div>
                    </div>
                </div>

                <button type="submit" id="btn-save-acc" class="w-full bg-brand-black text-white py-4 rounded-xl font-black text-xs uppercase tracking-widest hover:bg-brand-cyan hover:text-brand-black transition mt-2 shadow-lg">Guardar Cuenta</button>
            </form>
        </div>
    </div>

    <div id="commission-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-md" onclick="closeModal('commission-modal')"></div>
        <div class="relative bg-white w-full max-w-sm rounded-[2rem] shadow-2xl overflow-hidden animate-in fade-in zoom-in-95">
            <div class="p-6 bg-purple-50 border-b border-purple-100 text-center">
                <h3 class="text-lg font-black uppercase text-purple-900">Legalizar Comisión</h3>
                <p class="text-[10px] font-bold text-purple-400 uppercase tracking-widest" id="comm-acc-name">---</p>
            </div>
            
            <form id="commission-form" class="p-8 space-y-5">
                <input type="hidden" id="comm-acc-id">
                <input type="hidden" id="comm-type"> <input type="hidden" id="comm-rate-percent">
                <input type="hidden" id="comm-rate-fixed">

                <div id="comm-gross-container">
                    <label class="text-[9px] font-black text-gray-400 uppercase tracking-widest block mb-2">Valor de la Venta (Bruto)</label>
                    <input type="text" id="comm-gross" placeholder="$0" class="w-full bg-slate-50 border border-gray-200 p-3 rounded-xl font-bold text-lg text-center outline-none focus:border-purple-500 transition-all text-brand-black currency-input">
                </div>

                <div id="comm-net-container">
                    <label class="text-[9px] font-black text-gray-400 uppercase tracking-widest block mb-2">Valor Neto Recibido</label>
                    <input type="text" id="comm-net" placeholder="$0" class="w-full bg-white border-2 border-purple-100 p-3 rounded-xl font-bold text-lg text-center outline-none focus:border-purple-500 transition-all text-green-600 currency-input">
                </div>

                <div class="bg-gray-50 p-4 rounded-xl border border-dashed border-gray-200 text-center">
                    <p class="text-[9px] font-black text-gray-400 uppercase tracking-widest mb-1">Gasto a Registrar</p>
                    <p id="comm-calc-display" class="text-2xl font-black text-red-500 tracking-tight">$0</p>
                </div>

                <div class="flex flex-col gap-2">
                    <label class="text-[9px] font-black text-gray-400 uppercase tracking-widest">Concepto</label>
                    <input type="text" id="comm-desc" placeholder="Ej: Comisión Venta #123" class="w-full bg-white border border-gray-200 p-2 rounded-lg text-xs font-bold outline-none focus:border-purple-500">
                </div>

                <button type="submit" class="w-full bg-brand-black text-white py-4 rounded-xl font-black text-xs uppercase tracking-widest hover:bg-purple-500 transition shadow-lg">
                    Registrar Gasto
                </button>
            </form>
        </div>
    </div>

    <div id="transfer-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-md" onclick="closeModal('transfer-modal')"></div>
        <div class="relative bg-white w-full max-w-md rounded-[2rem] shadow-2xl p-8">
            <h3 class="text-xl font-black uppercase mb-6">Mover <span class="text-green-500">Dinero</span></h3>
            <form id="transfer-form" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[9px] font-black text-gray-400 uppercase tracking-widest block mb-1">Origen (Sale)</label>
                        <select id="tr-source" required class="w-full bg-red-50 border border-red-100 p-3 rounded-xl font-bold text-sm outline-none focus:border-red-500 cursor-pointer"></select>
                    </div>
                    <div>
                        <label class="text-[9px] font-black text-gray-400 uppercase tracking-widest block mb-1">Destino (Entra)</label>
                        <select id="tr-dest" required class="w-full bg-green-50 border border-green-100 p-3 rounded-xl font-bold text-sm outline-none focus:border-green-500 cursor-pointer"></select>
                    </div>
                </div>
                
                <div>
                    <label class="text-[9px] font-black text-gray-400 uppercase tracking-widest block mb-1">Monto a Transferir</label>
                    <input type="text" id="tr-amount" required placeholder="$0" class="w-full bg-slate-50 border border-gray-200 p-4 rounded-xl text-xl font-black text-center outline-none focus:border-brand-black currency-input">
                </div>

                <div id="tr-max-info" class="text-center hidden">
                    <p class="text-[9px] text-gray-400 font-bold">Máximo transferible (Neto): <span id="tr-max-val" class="text-brand-black font-black">$0</span></p>
                </div>
                
                <div id="tax-warning" class="hidden bg-yellow-50 p-3 rounded-xl border border-yellow-200 flex items-center gap-3">
                    <i class="fa-solid fa-triangle-exclamation text-yellow-600"></i>
                    <p class="text-[9px] font-bold text-yellow-700 uppercase">Se aplicará 4x1000: <span id="tax-preview" class="font-black">$0</span></p>
                </div>

                <button type="submit" class="w-full bg-brand-black text-white py-4 rounded-xl font-black text-xs uppercase tracking-widest hover:bg-brand-cyan transition mt-2 shadow-lg">Confirmar Transferencia</button>
            </form>
        </div>
    </div>

    <div id="history-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-md" onclick="closeModal('history-modal')"></div>
        <div class="relative bg-white w-full max-w-3xl rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col max-h-[85vh] animate-in fade-in zoom-in-95 duration-200">
            
            <div class="p-8 border-b border-gray-100 flex justify-between items-center bg-slate-50">
                <div>
                    <h3 class="text-xl font-black uppercase tracking-tighter text-brand-black">Extracto <span class="text-brand-cyan">Mensual</span></h3>
                    <p class="text-xs font-bold text-gray-400" id="hist-acc-name">---</p>
                </div>
                <div class="flex items-center gap-4">
                    <input type="month" id="hist-month" class="bg-white border border-gray-200 rounded-xl px-4 py-2 text-sm font-bold outline-none focus:border-brand-cyan shadow-sm cursor-pointer">
                    <button onclick="closeModal('history-modal')" class="w-10 h-10 rounded-full bg-white text-gray-400 border border-gray-200 hover:text-brand-red flex items-center justify-center transition">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
            </div>

            <div class="px-8 py-6 bg-white border-b border-gray-100 shrink-0">
                <div class="grid grid-cols-3 gap-4">
                    <div class="bg-green-50 p-4 rounded-2xl border border-green-100 flex flex-col justify-center items-center text-center">
                        <p class="text-[9px] font-black uppercase tracking-widest text-green-600 mb-1">Total Ingresos</p>
                        <p id="hist-in" class="text-xl font-black text-green-600 tracking-tight">$0</p>
                    </div>
                    <div class="bg-red-50 p-4 rounded-2xl border border-red-100 flex flex-col justify-center items-center text-center">
                        <p class="text-[9px] font-black uppercase tracking-widest text-red-500 mb-1">Total Egresos</p>
                        <p id="hist-out" class="text-xl font-black text-red-500 tracking-tight">$0</p>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-2xl border border-gray-200 flex flex-col justify-center items-center text-center">
                        <p class="text-[9px] font-black uppercase tracking-widest text-gray-400 mb-1">Flujo del Mes</p>
                        <p id="hist-balance" class="text-xl font-black text-brand-black tracking-tight">$0</p>
                    </div>
                </div>
            </div>

            <div class="flex-grow overflow-y-auto custom-scroll p-0 pb-12">
                <table class="w-full text-left">
                    <thead class="bg-slate-50 text-[9px] uppercase font-black text-gray-400 tracking-widest sticky top-0 z-10 border-b border-gray-100 shadow-sm">
                        <tr>
                            <th class="px-6 py-4 bg-slate-50">Fecha</th>
                            <th class="px-6 py-4 bg-slate-50">Concepto</th>
                            <th class="px-6 py-4 bg-slate-50">Categoría</th>
                            <th class="px-6 py-4 bg-slate-50 text-right">Valor</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body" class="divide-y divide-gray-50 text-xs font-medium text-gray-600">
                        <tr><td colspan="4" class="p-8 text-center">Cargando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, collection, addDoc, getDocs, doc, updateDoc, onSnapshot, runTransaction, Timestamp, query, where, orderBy } from '../js/firebase-init.js';
        import { loadAdminSidebar } from '../js/admin-ui.js';

        loadAdminSidebar();

        let accounts = [];

        // DOM Elements
        const grid = document.getElementById('accounts-grid');
        const accModal = document.getElementById('account-modal');
        const accForm = document.getElementById('account-form');
        const bankFields = document.getElementById('bank-fields');
        const platFields = document.getElementById('platform-fields');
        const accTypeInput = document.getElementById('acc-type');
        const feeTypeInput = document.getElementById('fee-type');
        
        // --- UTILIDAD: MONEDA ---
        document.querySelectorAll('.currency-input').forEach(input => {
            input.addEventListener('input', (e) => {
                let val = e.target.value.replace(/\D/g, "");
                if (val === "") { e.target.value = ""; return; }
                e.target.value = "$" + parseInt(val, 10).toLocaleString('es-CO');
                if(input.id === 'tr-amount') calculateTransferTax();
                if(input.id === 'comm-gross' || input.id === 'comm-net') calculateCommission();
            });
        });
        const getCleanVal = (id) => { const v = document.getElementById(id).value.replace(/\D/g, ""); return v ? parseInt(v, 10) : 0; };

        // --- LÓGICA VISUAL FORMULARIO CUENTA ---
        const toggleFields = () => {
            const type = accTypeInput.value;
            bankFields.classList.add('hidden');
            platFields.classList.add('hidden');
            
            if(type === 'banco') bankFields.classList.remove('hidden');
            if(type === 'plataforma') {
                platFields.classList.remove('hidden');
                toggleFeeFields();
            }
        };
        
        const toggleFeeFields = () => {
            const ft = feeTypeInput.value;
            const pDiv = document.getElementById('fee-var-group');
            const fDiv = document.getElementById('fee-fixed-container');
            
            if(ft === 'fixed') {
                pDiv.classList.add('hidden');
                fDiv.classList.remove('hidden');
                fDiv.classList.add('col-span-2');
            } else {
                pDiv.classList.remove('hidden');
                fDiv.classList.remove('hidden');
                fDiv.classList.remove('col-span-2');
            }
        };

        accTypeInput.onchange = toggleFields;
        feeTypeInput.onchange = toggleFeeFields;

        // --- CARGAR CUENTAS ---
        onSnapshot(collection(db, "accounts"), (snap) => {
            const sourceSelect = document.getElementById('tr-source');
            const destSelect = document.getElementById('tr-dest');
            grid.innerHTML = "";
            if(sourceSelect) sourceSelect.innerHTML = "<option value=''>Seleccione...</option>";
            if(destSelect) destSelect.innerHTML = "<option value=''>Seleccione...</option>";
            accounts = [];

            if (snap.empty) {
                grid.innerHTML = `<div class="col-span-3 text-center py-10 opacity-50"><p class="font-bold">No hay cuentas registradas.</p></div>`; return;
            }

            snap.forEach(d => {
                const acc = { id: d.id, ...d.data() };
                accounts.push(acc);

                let icon = 'fa-money-bill';
                let colorClass = 'bg-green-50 text-green-500';
                let actionBtn = '';

                // Cálculo de Saldo Transferible
                let transferable = acc.balance;
                if (!acc.isExempt && acc.type !== 'efectivo') {
                    transferable = Math.floor(acc.balance / 1.004);
                }

                if(acc.type === 'banco') { 
                    icon = 'fa-building-columns'; 
                    colorClass = 'bg-blue-50 text-blue-500'; 
                }
                if(acc.type === 'plataforma') { 
                    icon = 'fa-globe'; 
                    colorClass = 'bg-purple-50 text-purple-500';
                    actionBtn = `<button onclick="window.openCommissionModal('${acc.id}')" title="Deducir Comisión" class="w-full mt-4 py-2 rounded-xl bg-purple-50 text-purple-600 font-bold text-[10px] uppercase tracking-widest hover:bg-purple-500 hover:text-white transition flex items-center justify-center gap-2"><i class="fa-solid fa-percent"></i> Deducir Comisión</button>`;
                }

                let subInfo = '';
                if (acc.type === 'banco' && acc.accountNumber) subInfo = `<p class="text-[10px] text-gray-400 font-mono mt-1">${acc.accountCategory || ''} ••• ${acc.accountNumber.slice(-4)}</p>`;
                if (acc.type === 'plataforma') subInfo = `<p class="text-[10px] text-gray-400 font-bold mt-1">${acc.feeType === 'fixed' ? 'Tarifa Fija' : 'Tarifa Variable'}</p>`;

                // Badge Online Default
                const onlineBadge = acc.isDefaultOnline 
                    ? `<span class="absolute top-4 right-4 bg-brand-cyan text-white text-[8px] font-black px-2 py-1 rounded shadow-md uppercase tracking-widest z-20"><i class="fa-solid fa-link"></i> Conectada a Tienda</span>` 
                    : '';

                grid.innerHTML += `
                    <div class="bg-white p-6 rounded-[2rem] border border-gray-100 shadow-sm hover:shadow-xl transition-all group relative overflow-hidden flex flex-col justify-between ${acc.isDefaultOnline ? 'ring-2 ring-brand-cyan/20' : ''}">
                        ${onlineBadge}
                        <div class="absolute -right-4 -top-4 w-24 h-24 rounded-full ${colorClass.split(' ')[0]} blur-2xl opacity-50"></div>
                        <div>
                            <div class="flex justify-between items-start mb-6 relative z-10">
                                <div class="w-12 h-12 rounded-2xl flex items-center justify-center text-xl ${colorClass}"><i class="fa-solid ${icon}"></i></div>
                                <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button onclick="window.openHistory('${acc.name}')" title="Extracto" class="w-8 h-8 rounded-lg bg-slate-100 text-gray-500 hover:bg-brand-black hover:text-white transition flex items-center justify-center"><i class="fa-solid fa-list-ul text-xs"></i></button>
                                    <button onclick="window.editAccount('${acc.id}')" title="Editar" class="w-8 h-8 rounded-lg bg-slate-100 text-gray-500 hover:bg-brand-cyan hover:text-brand-black transition flex items-center justify-center"><i class="fa-solid fa-pen text-xs"></i></button>
                                </div>
                            </div>
                            <div class="relative z-10">
                                <div class="flex items-center gap-2"><h3 class="font-bold text-gray-600 text-xs uppercase tracking-widest">${acc.name}</h3>${acc.isExempt ? '<i class="fa-solid fa-shield-halved text-green-500 text-xs" title="Exenta 4x1000"></i>' : ''}</div>
                                ${subInfo}
                                <p class="text-3xl font-black text-brand-black tracking-tighter mt-2">$${(acc.balance || 0).toLocaleString('es-CO')}</p>
                                <p class="text-[9px] font-bold text-gray-400 mt-1">Disponible: <span class="text-gray-600">$${transferable.toLocaleString('es-CO')}</span></p>
                            </div>
                        </div>
                        ${actionBtn}
                    </div>
                `;

                const opt = `<option value="${acc.id}">${acc.name} ($${acc.balance.toLocaleString()})</option>`;
                if(sourceSelect) sourceSelect.innerHTML += opt;
                if(destSelect) destSelect.innerHTML += opt;
            });
        });

        // --- FUNCIONES ---
        window.openTransferModal = () => {
            document.getElementById('transfer-form').reset();
            document.getElementById('tax-warning').classList.add('hidden');
            document.getElementById('tr-max-info').classList.add('hidden');
            document.getElementById('transfer-modal').classList.remove('hidden');
        };

        window.openAccountModal = () => {
            accForm.reset();
            document.getElementById('edit-id').value = "";
            document.getElementById('modal-title').innerHTML = `Nueva <span class="text-brand-cyan">Cuenta</span>`;
            
            const balInput = document.getElementById('acc-balance');
            const balLabel = document.getElementById('lbl-balance');
            
            balInput.disabled = false;
            balInput.value = 0;
            balInput.classList.remove('bg-gray-200', 'text-gray-500');
            balInput.classList.add('bg-slate-50');
            balLabel.textContent = "Saldo Inicial *"; 

            toggleFields();
            document.getElementById('account-modal').classList.remove('hidden');
        };

        window.editAccount = (id) => {
            const acc = accounts.find(a => a.id === id);
            if(!acc) return;

            document.getElementById('edit-id').value = acc.id;
            document.getElementById('acc-name').value = acc.name;
            document.getElementById('acc-type').value = acc.type;
            
            const balInput = document.getElementById('acc-balance');
            const balLabel = document.getElementById('lbl-balance');
            balInput.value = acc.balance;
            balInput.disabled = true;
            balInput.classList.remove('bg-slate-50'); 
            balInput.classList.add('bg-gray-200', 'text-gray-500');
            balLabel.textContent = "Saldo Actual (No editable)";
            
            document.getElementById('acc-exempt').checked = acc.isExempt || false;
            // NUEVO: Cargar Checkbox Online
            document.getElementById('acc-online-default').checked = acc.isDefaultOnline || false;

            if(acc.type === 'banco') {
                document.getElementById('acc-number').value = acc.accountNumber || '';
                const radios = document.getElementsByName('bankType');
                if(acc.accountCategory === 'Corriente' && radios[1]) radios[1].checked = true; 
                else if(radios[0]) radios[0].checked = true;
            } else if (acc.type === 'plataforma') {
                document.getElementById('fee-type').value = acc.feeType || 'variable';
                document.getElementById('fee-percent').value = acc.feePercent || '';
                document.getElementById('fee-fixed').value = acc.feeFixed || '';
            }

            toggleFields();
            document.getElementById('modal-title').innerHTML = `Editar <span class="text-brand-cyan">Cuenta</span>`;
            document.getElementById('account-modal').classList.remove('hidden');
        };

        accForm.onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-save-acc');
            btn.disabled = true; btn.innerText = "Guardando...";
            const id = document.getElementById('edit-id').value;
            const type = document.getElementById('acc-type').value;
            
            const data = {
                name: document.getElementById('acc-name').value,
                type: type,
                updatedAt: Timestamp.now(),
                isExempt: document.getElementById('acc-exempt').checked,
                isDefaultOnline: document.getElementById('acc-online-default').checked // NUEVO: Guardar
            };

            if (!id) {
                data.balance = Number(document.getElementById('acc-balance').value);
                data.createdAt = Timestamp.now();
            }

            if (type === 'banco') {
                data.accountNumber = document.getElementById('acc-number').value;
                const radios = document.querySelector('input[name="bankType"]:checked');
                data.accountCategory = radios ? radios.value : 'Ahorros';
            } else if (type === 'plataforma') {
                data.feeType = document.getElementById('fee-type').value;
                data.feeFixed = Number(document.getElementById('fee-fixed').value);
                if(data.feeType === 'variable') data.feePercent = Number(document.getElementById('fee-percent').value);
            }

            try {
                if(id) await updateDoc(doc(db, "accounts", id), data);
                else await addDoc(collection(db, "accounts"), data);
                window.closeModal('account-modal');
            } catch (err) { alert(err.message); }
            finally { btn.disabled = false; btn.innerText = "Guardar Cuenta"; }
        };

        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');

        // --- COMISIONES ---
        window.openCommissionModal = (id) => {
            const acc = accounts.find(a => a.id === id);
            if (!acc) return;
            document.getElementById('comm-acc-id').value = acc.id;
            document.getElementById('comm-acc-name').textContent = acc.name;
            document.getElementById('comm-type').value = acc.feeType || 'variable';
            document.getElementById('comm-rate-percent').value = acc.feePercent || 0;
            document.getElementById('comm-rate-fixed').value = acc.feeFixed || 0;
            
            if(acc.feeType === 'fixed') {
                document.getElementById('comm-gross-container').classList.add('hidden');
                document.getElementById('comm-net-container').classList.add('hidden');
                document.getElementById('comm-calc-display').textContent = `$${(acc.feeFixed || 0).toLocaleString()}`;
            } else {
                document.getElementById('comm-gross-container').classList.remove('hidden');
                document.getElementById('comm-net-container').classList.remove('hidden');
                document.getElementById('comm-gross').value = "";
                document.getElementById('comm-net').value = "";
                document.getElementById('comm-calc-display').textContent = "$0";
            }
            document.getElementById('comm-desc').value = "";
            document.getElementById('commission-modal').classList.remove('hidden');
        };

        const calculateCommission = () => {
            const cType = document.getElementById('comm-type').value;
            if(cType === 'fixed') return;

            const gross = getCleanVal('comm-gross');
            const net = getCleanVal('comm-net');
            
            if (gross > 0 && net > 0) {
                const cost = gross - net;
                const display = cost > 0 ? `-$${cost.toLocaleString('es-CO')}` : `$0`;
                document.getElementById('comm-calc-display').textContent = display;
            }
        };

        document.getElementById('comm-gross').addEventListener('input', calculateCommission);
        document.getElementById('comm-net').addEventListener('input', calculateCommission);

        document.getElementById('commission-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('commission-form').querySelector('button');
            btn.disabled = true;

            const accId = document.getElementById('comm-acc-id').value;
            const cType = document.getElementById('comm-type').value;
            const desc = document.getElementById('comm-desc').value;
            const acc = accounts.find(a => a.id === accId);
            
            let cost = 0;
            let gross = 0;

            if (cType === 'fixed') {
                cost = Number(document.getElementById('comm-rate-fixed').value);
            } else {
                gross = getCleanVal('comm-gross');
                const net = getCleanVal('comm-net');
                cost = gross - net;
            }

            if (cost <= 0) { alert("Costo inválido"); btn.disabled=false; return; }

            try {
                await runTransaction(db, async (t) => {
                    const accRef = doc(db, "accounts", accId);
                    const accDoc = await t.get(accRef);
                    t.update(accRef, { balance: accDoc.data().balance - cost });
                    const expRef = doc(collection(db, "expenses"));
                    t.set(expRef, {
                        description: desc || (cType === 'fixed' ? 'Comisión Fija' : `Comisión Venta $${gross.toLocaleString()}`),
                        category: "Comisiones Plataforma",
                        amount: cost,
                        paymentMethod: acc.name,
                        date: Timestamp.now(),
                        createdAt: Timestamp.now(),
                        supplierName: acc.name
                    });
                });
                alert("✅ Registrado"); window.closeModal('commission-modal');
            } catch (e) { alert(e.message); } finally { btn.disabled = false; }
        };

        // --- TRANSFERENCIA ---
        const amountInput = document.getElementById('tr-amount');
        const sourceInput = document.getElementById('tr-source');
        
        function calculateTransferTax() {
            const accId = sourceInput.value;
            const amount = getCleanVal('tr-amount');
            const account = accounts.find(a => a.id === accId);
            const warning = document.getElementById('tax-warning');
            const maxInfo = document.getElementById('tr-max-info');
            const maxVal = document.getElementById('tr-max-val');

            if (!account) {
                warning.classList.add('hidden');
                maxInfo.classList.add('hidden');
                return;
            }

            let maxTransferable = account.balance;
            let taxRate = 0;

            if (account.type !== 'efectivo' && !account.isExempt) {
                taxRate = 0.004;
                maxTransferable = Math.floor(account.balance / (1 + taxRate));
            }

            maxVal.textContent = `$${maxTransferable.toLocaleString('es-CO')}`;
            maxInfo.classList.remove('hidden');

            if (taxRate > 0 && amount > 0) {
                const tax = Math.ceil(amount * taxRate);
                document.getElementById('tax-preview').textContent = `$${tax.toLocaleString()}`;
                warning.classList.remove('hidden');
            } else {
                warning.classList.add('hidden');
            }
        }
        
        sourceInput.onchange = calculateTransferTax;
        amountInput.addEventListener('change', calculateTransferTax);

        document.getElementById('transfer-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            btn.disabled = true;

            const sourceId = sourceInput.value;
            const destId = document.getElementById('tr-dest').value;
            const amount = getCleanVal('tr-amount');

            if(sourceId === destId) { alert("Cuentas iguales"); btn.disabled=false; return; }
            if(amount <= 0) { alert("Monto inválido"); btn.disabled=false; return; }

            try {
                await runTransaction(db, async (t) => {
                    const sRef = doc(db, "accounts", sourceId);
                    const dRef = doc(db, "accounts", destId);
                    const sDoc = await t.get(sRef);
                    const dDoc = await t.get(dRef);
                    const sData = sDoc.data();
                    const dData = dDoc.data();

                    let tax = 0;
                    if(sData.type !== 'efectivo' && !sData.isExempt) tax = Math.ceil(amount * 0.004);
                    
                    if(sData.balance < (amount + tax)) throw `Fondos insuficientes.`;

                    t.update(sRef, { balance: sData.balance - (amount + tax) });
                    t.update(dRef, { balance: dData.balance + amount });

                    const outRef = doc(collection(db, "expenses"));
                    t.set(outRef, {
                        description: `Transferencia a ${dData.name}`,
                        amount: amount,
                        category: "Transferencia Saliente",
                        paymentMethod: sData.name,
                        date: Timestamp.now(),
                        createdAt: Timestamp.now()
                    });

                    const inRef = doc(collection(db, "expenses"));
                    t.set(inRef, {
                        description: `Transferencia desde ${sData.name}`,
                        amount: amount,
                        category: "Transferencia Entrante",
                        paymentMethod: dData.name,
                        date: Timestamp.now(),
                        createdAt: Timestamp.now()
                    });

                    if(tax > 0) {
                        const txRef = doc(collection(db, "expenses"));
                        t.set(txRef, {
                            description: `4x1000 Transferencia`,
                            amount: tax,
                            category: "Impuestos",
                            paymentMethod: sData.name,
                            date: Timestamp.now(),
                            createdAt: Timestamp.now()
                        });
                    }
                });
                alert("✅ Transferencia Exitosa");
                window.closeModal('transfer-modal');
            } catch(e) { alert("Error: " + e); }
            finally { btn.disabled = false; }
        };

        // --- HISTORIAL ---
        window.openHistory = async (accountName) => {
            const modal = document.getElementById('history-modal');
            document.getElementById('hist-acc-name').textContent = accountName;
            const now = new Date();
            const monthStr = now.toISOString().slice(0, 7); 
            document.getElementById('hist-month').value = monthStr;
            
            loadHistoryData(accountName, monthStr);
            document.getElementById('hist-month').onchange = (e) => loadHistoryData(accountName, e.target.value);
            modal.classList.remove('hidden');
        };

        async function loadHistoryData(accountName, monthStr) {
            const tbody = document.getElementById('history-table-body');
            tbody.innerHTML = `<tr><td colspan="4" class="p-8 text-center"><i class="fa-solid fa-circle-notch fa-spin text-brand-cyan"></i></td></tr>`;
            document.getElementById('hist-in').textContent = "$0";
            document.getElementById('hist-out').textContent = "$0";
            document.getElementById('hist-balance').textContent = "$0";

            try {
                const [year, month] = monthStr.split('-').map(Number);
                const start = new Date(year, month - 1, 1);
                const end = new Date(year, month, 0, 23, 59, 59);

                const q = query(
                    collection(db, "expenses"), 
                    where("paymentMethod", "==", accountName), 
                    where("date", ">=", Timestamp.fromDate(start)), 
                    where("date", "<=", Timestamp.fromDate(end)), 
                    orderBy("date", "desc")
                );

                const snap = await getDocs(q);
                tbody.innerHTML = "";
                let totalIncome = 0;
                let totalExpense = 0;

                if(snap.empty) {
                    tbody.innerHTML = `<tr><td colspan="4" class="p-8 text-center text-xs text-gray-400 font-bold uppercase">Sin movimientos este mes</td></tr>`;
                    return;
                }

                snap.forEach(d => {
                    const t = d.data();
                    const dateObj = t.date?.toDate ? t.date.toDate() : new Date(t.date);
                    const absAmount = Math.abs(Number(t.amount));
                    
                    const isIncome = t.category === 'Ingreso Ventas' || t.category === 'Transferencia Entrante' || Number(t.amount) < 0;

                    if (isIncome) totalIncome += absAmount;
                    else totalExpense += absAmount;

                    const colorClass = isIncome ? 'text-green-600' : 'text-brand-red';
                    const sign = isIncome ? '+' : '-';
                    const iconCat = isIncome ? '<i class="fa-solid fa-arrow-down text-green-500 mr-1"></i>' : '';

                    tbody.innerHTML += `
                        <tr class="hover:bg-slate-50 transition border-b border-gray-50 last:border-0">
                            <td class="px-6 py-4 text-gray-500 font-mono text-xs">${dateObj.toLocaleDateString('es-CO')}</td>
                            <td class="px-6 py-4 font-bold text-brand-black text-xs uppercase">${t.description}</td>
                            <td class="px-6 py-4"><span class="bg-gray-100 px-2 py-1 rounded text-[9px] font-black uppercase text-gray-500 border border-gray-200">${iconCat}${t.category}</span></td>
                            <td class="px-6 py-4 text-right font-black ${colorClass} text-xs">${sign}$${absAmount.toLocaleString('es-CO')}</td>
                        </tr>`;
                });

                document.getElementById('hist-in').textContent = `$${totalIncome.toLocaleString('es-CO')}`;
                document.getElementById('hist-out').textContent = `$${totalExpense.toLocaleString('es-CO')}`;
                const net = totalIncome - totalExpense;
                document.getElementById('hist-balance').textContent = `${net >= 0 ? '+' : ''}$${net.toLocaleString('es-CO')}`;
                document.getElementById('hist-balance').className = `text-xl font-black tracking-tight ${net >= 0 ? 'text-green-600' : 'text-red-500'}`;

            } catch (e) { console.error(e); }
        }
    </script>
</body>
</html>