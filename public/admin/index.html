<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - PixelTech</title>
    <link rel="stylesheet" href="../css/styles.css">
    <script src="https://kit.fontawesome.com/0d623ded97.js" crossorigin="anonymous"></script>
    <style>
        .hidden { display: none !important; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #00AEC7; border-radius: 10px; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; opacity: 0; transform: translateY(10px); }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
    </style>
</head>

<body class="bg-slate-50 font-sans text-brand-black flex h-screen overflow-hidden selection:bg-brand-cyan selection:text-white">

    <div id="admin-sidebar"></div>

    <main class="flex-grow overflow-y-auto relative custom-scroll">
        <header class="bg-white/90 backdrop-blur-xl border-b border-gray-100 px-8 py-5 flex justify-between items-center sticky top-0 z-20 shadow-sm">
            <h2 class="font-black text-brand-black text-[9px] uppercase tracking-[0.3em]">Resumen de Operaciones</h2>
            <div class="flex items-center gap-4">
                <button id="btn-open-manual" class="bg-brand-black text-white px-6 py-2.5 rounded-xl font-black text-[10px] uppercase tracking-widest hover:bg-brand-cyan hover:text-brand-black hover:shadow-lg transition-all flex items-center gap-2 transform active:scale-95">
                    <i class="fa-solid fa-plus"></i> Nueva Venta
                </button>
                
                <div class="flex items-center gap-3 border-l border-gray-100 pl-4">
                    <span id="admin-name" class="text-xs font-bold text-brand-black hidden md:block">Admin</span>
                    <div class="w-10 h-10 bg-slate-100 text-brand-cyan rounded-xl flex items-center justify-center font-bold shadow-sm">
                        <i class="fa-solid fa-user-tie"></i>
                    </div>
                </div>
            </div>
        </header>

        <div class="p-8 max-w-[1800px] mx-auto pb-20">
            <div class="mb-8">
                <h1 class="text-4xl font-black text-brand-black tracking-tighter uppercase leading-none mb-2">Panel de <span class="text-brand-cyan">Control</span></h1>
                <p class="text-sm text-gray-400 font-bold tracking-wide">Visión general financiera y operativa.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6 mb-10 fade-in">
                
                <div onclick="window.location.href='orders.html'" class="bg-white p-6 rounded-[2rem] shadow-sm border border-gray-100 hover:shadow-xl hover:-translate-y-1 transition-all cursor-pointer group relative overflow-hidden">
                    <div class="absolute -right-6 -top-6 w-24 h-24 rounded-full bg-green-50 z-0 group-hover:scale-150 transition-transform duration-500"></div>
                    <div class="relative z-10">
                        <div class="flex justify-between items-start mb-4">
                            <div class="w-10 h-10 rounded-xl bg-green-100 text-green-600 flex items-center justify-center text-lg">
                                <i class="fa-solid fa-chart-line"></i>
                            </div>
                            <span class="bg-green-50 text-green-700 text-[8px] font-black px-2 py-1 rounded uppercase">Ingresos</span>
                        </div>
                        <p class="text-[9px] text-gray-400 uppercase font-black tracking-widest mb-1">Ventas Totales</p>
                        <h3 id="stat-sales" class="text-2xl font-black text-brand-black tracking-tight">$0</h3>
                    </div>
                </div>

                <div onclick="window.location.href='treasury.html'" class="bg-white p-6 rounded-[2rem] shadow-sm border border-gray-100 hover:shadow-xl hover:-translate-y-1 transition-all cursor-pointer group relative overflow-hidden">
                    <div class="absolute -right-6 -top-6 w-24 h-24 rounded-full bg-blue-50 z-0 group-hover:scale-150 transition-transform duration-500"></div>
                    <div class="relative z-10">
                        <div class="flex justify-between items-start mb-4">
                            <div class="w-10 h-10 rounded-xl bg-blue-100 text-blue-600 flex items-center justify-center text-lg">
                                <i class="fa-solid fa-building-columns"></i>
                            </div>
                            <span class="bg-blue-50 text-blue-700 text-[8px] font-black px-2 py-1 rounded uppercase">Tesorería</span>
                        </div>
                        <p class="text-[9px] text-gray-400 uppercase font-black tracking-widest mb-1">Saldo en Cuentas</p>
                        <h3 id="stat-treasury" class="text-2xl font-black text-brand-black tracking-tight">$0</h3>
                    </div>
                </div>

                <div onclick="window.location.href='orders.html'" class="bg-brand-black p-6 rounded-[2rem] shadow-lg shadow-gray-200 hover:shadow-2xl hover:-translate-y-1 transition-all cursor-pointer group relative overflow-hidden">
                    <div class="absolute -right-6 -top-6 w-24 h-24 rounded-full bg-gray-800 z-0 group-hover:scale-150 transition-transform duration-500"></div>
                    <div class="relative z-10">
                        <div class="flex justify-between items-start mb-4">
                            <div class="w-10 h-10 rounded-xl bg-gray-800 text-brand-cyan flex items-center justify-center text-lg border border-gray-700">
                                <i class="fa-solid fa-box-open"></i>
                            </div>
                            <span class="bg-brand-cyan text-brand-black text-[8px] font-black px-2 py-1 rounded uppercase">Prioridad</span>
                        </div>
                        <p class="text-[9px] text-gray-400 uppercase font-black tracking-widest mb-1">Pedidos por Alistar</p>
                        <h3 id="stat-packing" class="text-2xl font-black text-white tracking-tight">0</h3>
                    </div>
                </div>

                <div onclick="window.location.href='orders.html'" class="bg-white p-6 rounded-[2rem] shadow-sm border border-gray-100 hover:shadow-xl hover:-translate-y-1 transition-all cursor-pointer group relative overflow-hidden">
                    <div class="absolute -right-6 -top-6 w-24 h-24 rounded-full bg-orange-50 z-0 group-hover:scale-150 transition-transform duration-500"></div>
                    <div class="relative z-10">
                        <div class="flex justify-between items-start mb-4">
                            <div class="w-10 h-10 rounded-xl bg-orange-100 text-orange-600 flex items-center justify-center text-lg">
                                <i class="fa-solid fa-hand-holding-dollar"></i>
                            </div>
                            <span class="bg-orange-50 text-orange-700 text-[8px] font-black px-2 py-1 rounded uppercase">Por Cobrar</span>
                        </div>
                        <p class="text-[9px] text-gray-400 uppercase font-black tracking-widest mb-1">Cartera Clientes</p>
                        <h3 id="stat-receivable" class="text-2xl font-black text-brand-black tracking-tight">$0</h3>
                    </div>
                </div>

                <div onclick="window.location.href='treasury.html'" class="bg-white p-6 rounded-[2rem] shadow-sm border border-gray-100 hover:shadow-xl hover:-translate-y-1 transition-all cursor-pointer group relative overflow-hidden">
                    <div class="absolute -right-6 -top-6 w-24 h-24 rounded-full bg-red-50 z-0 group-hover:scale-150 transition-transform duration-500"></div>
                    <div class="relative z-10">
                        <div class="flex justify-between items-start mb-4">
                            <div class="w-10 h-10 rounded-xl bg-red-100 text-red-600 flex items-center justify-center text-lg">
                                <i class="fa-solid fa-file-invoice-dollar"></i>
                            </div>
                            <span class="bg-red-50 text-red-700 text-[8px] font-black px-2 py-1 rounded uppercase">Por Pagar</span>
                        </div>
                        <p class="text-[9px] text-gray-400 uppercase font-black tracking-widest mb-1">Deuda Proveedores</p>
                        <h3 id="stat-payable" class="text-2xl font-black text-brand-black tracking-tight">$0</h3>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-[2.5rem] shadow-xl border border-gray-100 overflow-hidden fade-in" style="animation-delay: 100ms;">
                <div class="p-8 border-b border-gray-50 flex justify-between items-center bg-slate-50/50">
                    <h3 class="font-black text-brand-black uppercase text-xs tracking-widest flex items-center gap-2">
                        <i class="fa-solid fa-list-check text-brand-cyan"></i> Pendientes por Atender
                    </h3>
                    <a href="orders.html" class="text-[10px] font-black uppercase text-gray-400 hover:text-brand-cyan transition">Ver Historial Completo</a>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm min-w-[900px]">
                        <thead class="bg-slate-50 text-[9px] uppercase font-black text-brand-black tracking-widest border-b border-gray-100">
                            <tr>
                                <th class="px-8 py-6 w-32">ID / Fecha</th>
                                <th class="px-8 py-6">Cliente</th>
                                <th class="px-8 py-6 text-center">Canal</th>
                                <th class="px-8 py-6 text-center">Estado Pago</th>
                                <th class="px-8 py-6 text-center">Logística</th>
                                <th class="px-8 py-6 text-right">Total</th>
                                <th class="px-8 py-6 text-center w-40">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body" class="divide-y divide-gray-50"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <div id="order-modal" class="fixed inset-0 z-[70] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-md transition-opacity" onclick="document.getElementById('order-modal').classList.add('hidden')"></div>
        <div class="relative bg-white w-full max-w-5xl rounded-[2.5rem] shadow-2xl flex flex-col max-h-[90vh] overflow-hidden animate-fadeIn">
            <div class="p-8 border-b border-gray-50 flex justify-between items-center bg-slate-50/50">
                <div class="flex items-center gap-6">
                    <div id="modal-source-icon" class="w-16 h-16 bg-white rounded-2xl flex items-center justify-center text-2xl shadow-sm border border-gray-100"></div>
                    <div>
                        <div class="flex items-center gap-3">
                            <h3 class="text-3xl font-black tracking-tighter uppercase text-brand-black" id="modal-order-id">#ORDEN</h3>
                            <span id="modal-order-status-badge" class="px-3 py-1 rounded-full text-[10px] font-black uppercase border">Cargando...</span>
                        </div>
                        <p id="modal-order-date" class="text-[10px] font-bold text-brand-black uppercase tracking-widest mt-1">...</p>
                    </div>
                </div>
                <button class="w-10 h-10 rounded-full bg-white border border-gray-200 text-brand-black hover:bg-brand-red hover:text-white transition flex items-center justify-center" onclick="document.getElementById('order-modal').classList.add('hidden')"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-8 overflow-y-auto custom-scroll space-y-8 bg-white">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 space-y-6">
                        <div class="bg-white border border-gray-100 p-6 rounded-[2rem] shadow-sm">
                            <h4 class="text-[9px] font-black uppercase tracking-[0.2em] text-brand-black mb-4 flex items-center gap-2"><i class="fa-solid fa-user-tag text-brand-cyan"></i> Cliente</h4>
                            <p id="modal-client-name" class="font-black text-brand-black uppercase text-sm mb-1">...</p>
                            <p id="modal-client-doc" class="text-[10px] font-bold text-brand-black uppercase mb-1">...</p>
                            <p id="modal-client-contact" class="text-xs text-brand-black font-bold break-all">...</p>
                        </div>
                        <div class="bg-white border border-gray-100 p-6 rounded-[2rem] shadow-sm">
                            <h4 class="text-[9px] font-black uppercase tracking-[0.2em] text-brand-black mb-4 flex items-center gap-2"><i class="fa-solid fa-map-location-dot text-brand-cyan"></i> Dirección de Entrega</h4>
                            <p id="modal-delivery-address" class="text-xs font-bold text-brand-black mb-1">...</p>
                            <p id="modal-delivery-city" class="text-[10px] text-brand-black font-black uppercase">...</p>
                            <div id="modal-order-notes" class="mt-4 p-4 bg-yellow-50 rounded-xl text-[10px] text-yellow-700 font-bold border border-yellow-100 hidden"><i class="fa-regular fa-note-sticky mr-1"></i> <span id="note-text"></span></div>
                        </div>
                        <div id="modal-billing-section" class="hidden bg-brand-cyan/5 border border-brand-cyan/10 p-6 rounded-[2rem]">
                            <h4 class="text-[9px] font-black uppercase tracking-[0.2em] text-brand-cyan mb-4 flex items-center gap-2"><i class="fa-solid fa-file-invoice-dollar"></i> Facturación</h4>
                            <div class="space-y-3"><div><p class="text-[8px] font-black text-gray-400 uppercase">Razón Social</p><p id="bill-modal-name" class="text-xs font-bold text-brand-black">--</p></div><div><p class="text-[8px] font-black text-gray-400 uppercase">NIT / RUT</p><p id="bill-modal-id" class="text-xs font-bold text-brand-black">--</p></div><div><p class="text-[8px] font-black text-gray-400 uppercase">Correo</p><p id="bill-modal-email" class="text-xs font-bold text-brand-black break-all">--</p></div></div>
                        </div>
                    </div>
                    <div class="lg:col-span-2">
                         <h4 class="text-[9px] font-black uppercase tracking-[0.2em] text-brand-black mb-4 flex items-center gap-2"><i class="fa-solid fa-boxes-packing text-brand-cyan"></i> Picking List & Seriales</h4>
                        <div class="bg-slate-50 rounded-[2rem] border border-gray-100 overflow-hidden" id="modal-items-list-responsive"></div>
                    </div>
                </div>
            </div>
            <div class="p-8 bg-slate-50 border-t border-gray-100 flex flex-col md:flex-row justify-between items-center gap-6">
                <div class="flex gap-10 text-right md:text-left">
                    <div><p class="text-[9px] font-black text-brand-black uppercase tracking-widest">Subtotal</p><p id="modal-order-subtotal" class="text-sm font-bold text-brand-black">---</p></div>
                    <div><p class="text-[9px] font-black text-brand-cyan uppercase tracking-widest">Envío</p><p id="modal-order-shipping" class="text-sm font-bold text-brand-cyan">---</p></div>
                    <div class="pl-8 border-l border-gray-200"><p class="text-[9px] font-black text-brand-black uppercase tracking-widest">Total Neto</p><h4 id="modal-order-total" class="text-3xl font-black text-brand-black leading-none">---</h4></div>
                </div>
                <div class="flex items-center gap-4 w-full md:w-auto justify-end">
                    <div id="modal-footer-msg" class="text-xs font-bold uppercase tracking-widest hidden"></div>
                    <div id="modal-footer-actions" class="flex gap-3 w-full md:w-auto hidden">
                        <button id="btn-save-alistado" onclick="window.saveAlistamiento(() => window.location.reload())" class="flex-1 md:flex-none bg-brand-black text-white px-8 py-4 rounded-xl font-black uppercase text-[10px] tracking-widest hover:bg-brand-cyan hover:text-brand-black transition-all shadow-xl">Guardar Alistamiento</button>
                        <button id="btn-set-despachado" onclick="window.openDispatchModal()" class="flex-1 md:flex-none bg-green-500 text-white px-8 py-4 rounded-xl font-black uppercase text-[10px] tracking-widest hover:bg-green-600 transition-all shadow-xl"><i class="fa-solid fa-truck-fast mr-2"></i> Marcar Despachado</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="dispatch-modal" class="fixed inset-0 z-[80] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/70 backdrop-blur-sm" onclick="document.getElementById('dispatch-modal').classList.add('hidden')"></div>
        <div class="relative bg-white w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl text-center">
            <h3 class="text-xl font-black text-brand-black uppercase mb-6">Confirmar Envío</h3>
            <div class="space-y-4 mb-8 text-left">
                <select id="dispatch-carrier" class="w-full bg-slate-50 border border-gray-200 rounded-xl p-3 text-sm font-bold outline-none text-brand-black"><option value="">Transportadora...</option><option value="Servientrega">Servientrega</option><option value="Interrapidisimo">Interrapidísimo</option><option value="Envía">Envía</option><option value="Coordinadora">Coordinadora</option></select>
                <input type="text" id="dispatch-tracking" placeholder="Número de Guía" class="w-full bg-slate-50 border border-gray-200 rounded-xl p-3 text-sm font-mono font-bold outline-none text-brand-black">
            </div>
            <button id="btn-confirm-dispatch" onclick="window.confirmDispatch(() => window.location.reload())" class="w-full bg-green-500 text-white font-black py-4 rounded-xl shadow-lg uppercase text-xs tracking-widest hover:bg-green-600 transition">Confirmar y Enviar</button>
        </div>
    </div>

    <script type="module">
        import '../js/admin-guard.js';
        import { db, collection, getDocs, orderBy, query, limit, auth, doc, getDoc, updateDoc, addDoc, where } from '../js/firebase-init.js';
        import { loadAdminSidebar } from '../js/admin-ui.js';
        import { initManualSale, openManualSaleModal } from '../js/manual-sale.js';
        import '../js/order-actions.js';

        loadAdminSidebar();

        // Inicializar el modal de venta manual
        initManualSale(() => {
            fetchDashboardData(); 
        });

        document.getElementById('btn-open-manual').onclick = openManualSaleModal;

        const tableBody = document.getElementById('orders-table-body');
        const safeSetText = (id, text) => { const el = document.getElementById(id); if (el) el.textContent = text; };

        auth.onAuthStateChanged(user => {
            if (user) document.getElementById('admin-name').textContent = user.displayName || "Admin";
        });

        // --- DASHBOARD DATA ---
        async function fetchDashboardData() {
            try {
                // 1. TOTAL VENTAS (Pagados + Entregados)
                const incomeSnap = await getDocs(query(collection(db, "orders"), where("status", "in", ["PAGADO", "DESPACHADO", "ENTREGADO"])));
                let totalIncome = 0;
                incomeSnap.forEach(d => totalIncome += (d.data().total || 0));
                safeSetText('stat-sales', `$${totalIncome.toLocaleString('es-CO')}`);

                // 2. DINERO EN CUENTAS
                const accountsSnap = await getDocs(collection(db, "accounts"));
                let totalTreasury = 0;
                accountsSnap.forEach(d => totalTreasury += (d.data().balance || 0));
                safeSetText('stat-treasury', `$${totalTreasury.toLocaleString('es-CO')}`);

                // 3. POR ALISTAR (OPERATIVO) -> (Pagados o Pendientes Manuales)
                const qPacking = query(collection(db, "orders"), where("status", "in", ["PAGADO", "PENDIENTE"]));
                const packingSnap = await getDocs(qPacking);
                safeSetText('stat-packing', packingSnap.size);

                // 4. CARTERA (POR COBRAR) -> (Entregado/Creado pero no pagado)
                const qReceivable = query(collection(db, "orders"), where("paymentStatus", "==", "PENDING"));
                const receivableSnap = await getDocs(qReceivable);
                let totalReceivable = 0;
                receivableSnap.forEach(d => {
                    if (d.data().status !== 'CANCELADO' && d.data().status !== 'RECHAZADO') {
                        totalReceivable += (d.data().total || 0);
                    }
                });
                safeSetText('stat-receivable', `$${totalReceivable.toLocaleString('es-CO')}`);

                // 5. DEUDA PROVEEDORES
                let totalPayable = 0;
                try {
                    const qPayable = query(collection(db, "payables"), where("status", "==", "PENDING"));
                    const payableSnap = await getDocs(qPayable);
                    payableSnap.forEach(d => totalPayable += (d.data().amount || 0));
                } catch(err) { console.warn(err); }
                safeSetText('stat-payable', `$${totalPayable.toLocaleString('es-CO')}`);


                // --- CARGAR TABLA PENDIENTES (Con Lógica de Corte) ---
                if (!tableBody) return;
                tableBody.innerHTML = `<tr><td colspan="7" class="p-8 text-center"><i class="fa-solid fa-circle-notch fa-spin text-brand-cyan"></i> Cargando...</td></tr>`;

                const configSnap = await getDoc(doc(db, "config", "shipping"));
                const cutoffTimeStr = configSnap.exists() ? (configSnap.data().cutoffTime || "14:00") : "14:00";
                
                const now = new Date();
                const [hours, minutes] = cutoffTimeStr.split(':').map(Number);
                const cutoffDateToday = new Date(now);
                cutoffDateToday.setHours(hours, minutes, 0, 0);

                const q = query(collection(db, "orders"), where("status", "in", ["PAGADO", "PENDIENTE", "ALISTADO"]), orderBy("createdAt", "desc"));
                const snapshot = await getDocs(q);
                tableBody.innerHTML = "";

                if (snapshot.empty) {
                    tableBody.innerHTML = `<tr><td colspan="7" class="p-10 text-center text-xs text-brand-black font-bold uppercase">¡Todo al día! No hay pedidos pendientes.</td></tr>`;
                    return;
                }

                const todayOrders = [];
                const tomorrowOrders = [];

                snapshot.forEach(d => {
                    const o = d.data();
                    const orderDate = o.createdAt?.toDate ? o.createdAt.toDate() : new Date();
                    const isToday = orderDate.toDateString() === now.toDateString();
                    
                    if (isToday && orderDate > cutoffDateToday) { tomorrowOrders.push({ id: d.id, ...o }); } 
                    else { todayOrders.push({ id: d.id, ...o }); }
                });

                if (todayOrders.length > 0) {
                    tableBody.innerHTML += `<tr class="bg-green-50/50 border-b border-green-100"><td colspan="7" class="py-4 px-8"><div class="flex items-center gap-3 text-green-700"><div class="p-1.5 bg-green-100 rounded-lg"><i class="fa-solid fa-truck-fast text-xs"></i></div><span class="text-[10px] font-black uppercase tracking-widest">Prioridad: Despachar Hoy (Antes de ${cutoffTimeStr})</span></div></td></tr>`;
                    todayOrders.forEach(o => renderRow(o));
                }

                if (tomorrowOrders.length > 0) {
                    tableBody.innerHTML += `<tr class="bg-blue-50/50 border-b border-blue-100"><td colspan="7" class="py-4 px-8"><div class="flex items-center gap-3 text-blue-700"><div class="p-1.5 bg-blue-100 rounded-lg"><i class="fa-solid fa-clock text-xs"></i></div><span class="text-[10px] font-black uppercase tracking-widest">Despachar Mañana (Después de ${cutoffTimeStr})</span></div></td></tr>`;
                    tomorrowOrders.forEach(o => renderRow(o));
                }

            } catch (e) { console.error("Error dashboard:", e); }
        }

        function renderRow(o) {
            const isTienda = o.source === 'TIENDA' || o.source === 'TIENDA_WEB';
            let sClass = 'bg-gray-100 text-gray-500', sText = o.status;
            if (o.status === 'PENDIENTE') { sClass = 'bg-yellow-100 text-yellow-700 border-yellow-200'; sText = 'Por Atender'; }
            if (o.status === 'ALISTADO') { sClass = 'bg-blue-100 text-blue-700 border-blue-200'; sText = 'Alistado'; }
            if (o.status === 'PAGADO') { sClass = 'bg-red-100 text-red-600 border-red-200 animate-pulse'; sText = 'PAGADO (URGENTE)'; }
            
            let pBadge = `<span class="text-[9px] font-black uppercase text-red-500 bg-red-50 px-2 py-1 rounded border border-red-100">Cartera</span>`;
            if (o.status === 'PAGADO' || o.paymentStatus === 'PAID') {
                pBadge = `<span class="text-[9px] font-black uppercase text-green-600 bg-green-50 px-2 py-1 rounded border border-green-100"><i class="fa-solid fa-check"></i> Pagado</span>`;
            }

            const dateStr = o.createdAt?.toDate ? o.createdAt.toDate().toLocaleDateString('es-CO', {day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit'}) : '--';

            // Botón Factura Azul
            const invoiceBtn = o.requiresInvoice 
                ? `<span class="w-9 h-9 rounded-xl bg-blue-50 text-blue-500 border border-blue-100 flex items-center justify-center cursor-default" title="Factura Solicitada"><i class="fa-solid fa-check text-xs"></i></span>`
                : `<button onclick="window.requestInvoice('${o.id}')" title="Solicitar Factura" class="w-9 h-9 rounded-xl bg-white border border-blue-200 text-blue-500 hover:bg-blue-500 hover:text-white transition shadow-sm flex items-center justify-center"><i class="fa-solid fa-file-invoice-dollar text-xs"></i></button>`;

            tableBody.innerHTML += `
                <tr class="hover:bg-slate-50 transition border-b border-gray-50 group">
                    <td class="px-8 py-6">
                        <div class="font-mono text-[10px] text-brand-black uppercase font-bold">#${o.id.slice(0, 8)}</div>
                        <div class="text-[9px] font-bold text-brand-black mt-1">${dateStr}</div>
                    </td>
                    <td class="px-8 py-6">
                        <div class="font-black text-brand-black uppercase text-xs">${o.userName || 'Cliente'}</div>
                        <div class="text-[9px] text-brand-black font-bold">${o.phone || ''}</div>
                    </td>
                    <td class="px-8 py-6 text-center">
                        <span class="text-[8px] font-black px-2 py-0.5 rounded shadow-sm ${isTienda ? 'bg-brand-cyan text-brand-black' : 'bg-brand-black text-white'}">${isTienda ? 'WEB' : 'MANUAL'}</span>
                    </td>
                    <td class="px-8 py-6 text-center">${pBadge}</td>
                    <td class="px-8 py-6 text-center">
                        <span class="${sClass} px-3 py-1 rounded-full text-[9px] font-black uppercase border shadow-sm block w-fit mx-auto">${sText}</span>
                    </td>
                    <td class="px-8 py-6 text-right font-black text-brand-black text-sm">$${(o.total || 0).toLocaleString('es-CO')}</td>
                    <td class="px-8 py-6 text-center">
                        <div class="flex items-center justify-center gap-2">
                            <button onclick="window.viewOrderDetail('${o.id}')" title="Ver Detalle" class="w-9 h-9 rounded-xl bg-white border border-gray-200 text-brand-black hover:bg-brand-black hover:text-white transition shadow-sm flex items-center justify-center"><i class="fa-solid fa-eye text-xs"></i></button>
                            <button onclick="window.printRemission('${o.id}')" title="Imprimir Recibo" class="w-9 h-9 rounded-xl bg-white border border-red-200 text-red-500 hover:bg-red-500 hover:text-white transition shadow-sm flex items-center justify-center"><i class="fa-solid fa-file-pdf text-xs"></i></button>
                            ${invoiceBtn}
                        </div>
                    </td>
                </tr>`;
        }

        fetchDashboardData();
    </script>
</body>
</html>