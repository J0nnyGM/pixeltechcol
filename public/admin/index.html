<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - PixelTech</title>
    <link rel="stylesheet" href="../css/styles.css">
    <script src="https://kit.fontawesome.com/0d623ded97.js" crossorigin="anonymous"></script>
    <style>
        .hidden { display: none; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #00e5ff; border-radius: 10px; }
    </style>
</head>

<body class="bg-gray-100 font-sans text-brand-black hidden flex h-screen overflow-hidden">

    <div id="admin-sidebar"></div>

    <main class="flex-grow overflow-y-auto bg-slate-50 relative">
        <header class="bg-white border-b border-gray-200 px-8 py-4 flex justify-between items-center sticky top-0 z-10">
            <h2 class="font-bold text-gray-500 text-sm uppercase tracking-widest">Resumen de Operaciones</h2>
            <div class="flex items-center gap-4">
                <button id="btn-open-manual" class="bg-brand-black text-white px-4 py-2 rounded-xl font-black text-[10px] uppercase tracking-widest hover:bg-brand-cyan transition shadow-lg mr-4">
                    <i class="fa-solid fa-plus mr-1"></i> Venta Directa
                </button>
                <span id="admin-name" class="text-sm font-bold text-brand-black italic">Admin</span>
                <div class="w-10 h-10 bg-brand-cyan text-white rounded-full flex items-center justify-center font-bold shadow-sm">
                    <i class="fa-solid fa-user-tie"></i>
                </div>
            </div>
        </header>

        <div class="p-8">
            <div class="mb-8">
                <h1 class="text-3xl font-black text-brand-black tracking-tight">Panel de Control</h1>
                <p class="text-gray-500 text-sm">Monitoreo de ventas y remisiones en tiempo real.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <p class="text-xs text-gray-400 uppercase font-black tracking-widest">Ingresos Totales</p>
                    <h3 id="stat-sales" class="text-3xl font-black text-brand-black mt-2">$0</h3>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <p class="text-xs text-gray-400 uppercase font-black tracking-widest">√ìrdenes & Remisiones</p>
                    <h3 id="stat-orders" class="text-3xl font-black text-brand-black mt-2">0</h3>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <p class="text-xs text-gray-400 uppercase font-black tracking-widest">Clientes Base</p>
                    <h3 id="stat-users" class="text-3xl font-black text-brand-black mt-2">0</h3>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
                <div class="p-6 border-b border-gray-100 bg-gray-50/50 flex justify-between items-center">
                    <h3 class="font-black text-brand-black uppercase text-xs tracking-widest">Registro Unificado de Ventas</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 text-[10px] uppercase font-black text-gray-400 tracking-widest">
                            <tr>
                                <th class="px-6 py-4">ID / Origen</th>
                                <th class="px-6 py-4">Cliente</th>
                                <th class="px-6 py-4">Fecha</th>
                                <th class="px-6 py-4">Estado</th>
                                <th class="px-6 py-4 text-right">Monto</th>
                                <th class="px-6 py-4 text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <div id="order-modal" class="fixed inset-0 z-[70] hidden transition-all duration-300">
        <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-md" id="close-modal-overlay"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-2 sm:p-4 text-center">
                <div class="relative transform overflow-hidden rounded-3xl bg-white text-left shadow-2xl transition-all w-full max-w-4xl flex flex-col max-h-[95vh] sm:max-h-[90vh]">
                    <div class="bg-white px-5 py-4 sm:px-8 sm:py-6 border-b border-gray-100 flex justify-between items-center shrink-0">
                        <div class="flex flex-col gap-1">
                            <div class="flex items-center gap-2 flex-wrap">
                                <h3 class="text-lg sm:text-2xl font-black text-brand-black tracking-tight" id="modal-order-id">#ORDEN</h3>
                                <span id="modal-order-status-badge" class="px-2 py-0.5 sm:px-3 sm:py-1 rounded-full text-[9px] sm:text-[10px] font-black uppercase border shadow-sm">---</span>
                            </div>
                            <p class="text-[10px] sm:text-xs text-gray-500 flex items-center gap-1">
                                <i class="fa-regular fa-calendar"></i> <span id="modal-order-date">...</span>
                            </p>
                        </div>
                        <button id="close-modal-btn" class="text-gray-400 hover:text-brand-red bg-gray-50 p-2 rounded-xl transition">
                            <i class="fa-solid fa-xmark text-xl"></i>
                        </button>
                    </div>

                    <div class="overflow-y-auto px-4 py-4 sm:px-8 sm:py-6 bg-slate-50/30 space-y-6 custom-scroll">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4 bg-white p-4 sm:p-5 rounded-2xl shadow-sm border border-gray-100">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-brand-cyan/10 text-brand-cyan rounded-xl flex items-center justify-center shrink-0">
                                    <i class="fa-solid fa-user"></i>
                                </div>
                                <div class="overflow-hidden">
                                    <p class="text-[9px] font-black text-gray-400 uppercase tracking-widest">Cliente</p>
                                    <p id="modal-client-name" class="font-bold text-brand-black text-sm truncate">...</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3 border-t sm:border-t-0 sm:border-l border-gray-100 pt-3 sm:pt-0 sm:pl-4">
                                <div class="w-10 h-10 bg-slate-100 text-slate-500 rounded-xl flex items-center justify-center shrink-0">
                                    <i class="fa-solid fa-phone"></i>
                                </div>
                                <div class="overflow-hidden">
                                    <p class="text-[9px] font-black text-gray-400 uppercase tracking-widest">Contacto</p>
                                    <p id="modal-client-email" class="font-medium text-gray-600 text-xs truncate">...</p>
                                </div>
                            </div>
                        </div>

                        <div>
                            <h4 class="font-black text-brand-black uppercase text-xs tracking-widest mb-3 flex items-center gap-2">
                                <i class="fa-solid fa-clipboard-check text-brand-cyan"></i> Picking List
                            </h4>
                            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                                <div class="hidden md:grid grid-cols-12 bg-gray-50 border-b border-gray-100 px-6 py-3 text-[10px] uppercase font-black text-gray-400">
                                    <div class="col-span-7">Producto</div>
                                    <div class="col-span-5 text-center">Serial Numbers (SN)</div>
                                </div>
                                <div id="modal-items-list-responsive" class="divide-y divide-gray-100"></div>
                            </div>
                        </div>

                        <div class="bg-brand-black rounded-2xl p-5 text-white flex justify-between items-center shadow-lg">
                            <div class="flex flex-col">
                                <span class="text-[10px] font-black text-brand-cyan uppercase tracking-widest">Monto Total</span>
                                <span id="modal-order-total" class="text-2xl font-black">---</span>
                            </div>
                            <i class="fa-solid fa-receipt text-3xl opacity-20"></i>
                        </div>
                    </div>

                    <div class="bg-white px-5 py-4 sm:px-8 sm:py-6 border-t border-gray-100 flex flex-col sm:flex-row gap-3">
                        <button id="close-modal-footer" class="order-2 sm:order-1 px-6 py-3 text-gray-500 font-bold rounded-xl hover:bg-gray-100 transition text-xs uppercase">Cerrar</button>
                        <div class="order-1 sm:order-2 flex-grow flex flex-col sm:flex-row gap-3">
                            <button id="btn-save-alistado" class="hidden w-full px-8 py-3 bg-brand-cyan text-white font-black rounded-xl hover:bg-cyan-600 transition shadow-lg uppercase text-xs tracking-widest">Guardar Alistamiento</button>
                            <button id="btn-set-despachado" class="hidden w-full px-8 py-3 bg-green-500 text-white font-black rounded-xl hover:bg-green-600 transition shadow-lg uppercase text-xs tracking-widest">Despachar Pedido</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="dispatch-modal" class="fixed inset-0 z-[80] hidden">
        <div class="fixed inset-0 bg-slate-900/70 backdrop-blur-sm" id="close-dispatch-overlay"></div>
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="relative w-full max-w-md transform overflow-hidden rounded-3xl bg-white p-8 shadow-2xl transition-all border border-gray-100">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fa-solid fa-truck-fast text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-black text-brand-black uppercase tracking-tight">Datos de Env√≠o</h3>
                    <p class="text-sm text-gray-500">Asigna la transportadora para finalizar el despacho.</p>
                </div>
                <div class="space-y-4 mb-8">
                    <div>
                        <label class="block text-[10px] font-black text-gray-400 uppercase mb-1">Transportadora</label>
                        <select id="dispatch-carrier" class="w-full bg-slate-50 border border-gray-200 rounded-xl p-3 text-sm font-bold focus:border-brand-cyan outline-none transition">
                            <option value="">Seleccione...</option>
                            <option value="Servientrega">Servientrega</option>
                            <option value="Env√≠a">Env√≠a</option>
                            <option value="Interrapidisimo">Interrapid√≠simo</option>
                            <option value="Coordinadora">Coordinadora</option>
                            <option value="DHL">DHL</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-gray-400 uppercase mb-1">N√∫mero de Gu√≠a</label>
                        <input type="text" id="dispatch-tracking" placeholder="Ej: 123456789" class="w-full bg-slate-50 border border-gray-200 rounded-xl p-3 text-sm font-mono font-bold focus:border-brand-cyan outline-none transition">
                    </div>
                </div>
                <div class="flex flex-col gap-3">
                    <button id="btn-confirm-dispatch" class="w-full bg-green-500 hover:bg-green-600 text-white font-black py-4 rounded-xl transition shadow-lg uppercase text-xs tracking-widest">Confirmar Despacho</button>
                    <button id="btn-cancel-dispatch" class="w-full bg-white text-gray-400 font-bold py-3 rounded-xl hover:bg-gray-50 transition text-xs uppercase">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="manual-modal" class="fixed inset-0 z-[90] hidden">
        <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-md" id="close-manual-overlay"></div>
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="relative transform overflow-hidden rounded-[2.5rem] bg-white text-left shadow-2xl transition-all w-full max-w-2xl flex flex-col max-h-[90vh]">
                <div class="p-8 border-b border-gray-100 flex justify-between items-center bg-white sticky top-0 z-10">
                    <div>
                        <h3 class="text-2xl font-black text-brand-black tracking-tighter uppercase">Nueva Remisi√≥n Manual</h3>
                        <p class="text-xs text-gray-400 font-bold tracking-widest mt-1">VENTA DIRECTA / WHATSAPP</p>
                    </div>
                    <button id="btn-close-manual" class="text-gray-400 hover:text-brand-red p-2 bg-gray-50 rounded-xl transition"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>

                <div class="p-8 overflow-y-auto space-y-6 custom-scroll bg-slate-50/30">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest ml-1">Cliente</label>
                            <input type="text" id="m-cust-name" placeholder="Nombre completo" class="w-full bg-white border border-gray-100 p-4 rounded-2xl text-sm focus:ring-2 focus:ring-brand-cyan/20 outline-none transition">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest ml-1">Tel√©fono</label>
                            <input type="text" id="m-cust-phone" placeholder="WhatsApp / Celular" class="w-full bg-white border border-gray-100 p-4 rounded-2xl text-sm focus:ring-2 focus:ring-brand-cyan/20 outline-none transition">
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <h4 class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Seleccionar Productos</h4>
                            <button id="btn-add-item-row" class="text-brand-cyan font-black text-[10px] uppercase hover:underline">+ A√±adir Item</button>
                        </div>
                        <div id="manual-items-container" class="space-y-3">
                            </div>
                    </div>
                </div>

                <div class="p-8 border-t border-gray-100 bg-white sticky bottom-0 flex items-center justify-between">
                    <div>
                        <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Monto Total Estimado</p>
                        <h4 id="manual-total-display" class="text-2xl font-black text-brand-black">$0</h4>
                    </div>
                    <button id="btn-save-manual" class="bg-brand-cyan text-white font-black px-10 py-4 rounded-2xl shadow-lg shadow-cyan-500/20 uppercase text-xs tracking-widest hover:scale-105 transition">Crear Remisi√≥n</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import '../js/admin-guard.js';
        import { db, collection, getDocs, orderBy, query, limit, auth, doc, getDoc, updateDoc, addDoc } from '../js/firebase-init.js';

        // Referencias
        const modal = document.getElementById('order-modal');
        const dispatchModal = document.getElementById('dispatch-modal');
        const manualModal = document.getElementById('manual-modal');
        const itemsContainer = document.getElementById('modal-items-list-responsive');
        const manualItemsContainer = document.getElementById('manual-items-container');
        
        let currentOrderId = null;
        let allProducts = []; // Para el buscador manual

        auth.onAuthStateChanged(user => {
            if (user) document.getElementById('admin-name').textContent = user.displayName || user.email;
        });

        // --- MANEJO DE CIERRE ---
        const closeAll = () => { 
            modal.classList.add('hidden'); 
            dispatchModal.classList.add('hidden'); 
            manualModal.classList.add('hidden');
        };
        document.querySelectorAll('#close-modal-btn, #close-modal-footer, #close-modal-overlay, #btn-cancel-dispatch, #close-dispatch-overlay, #btn-close-manual, #close-manual-overlay')
            .forEach(b => b.onclick = closeAll);

        // --- L√ìGICA VENTA MANUAL (REMISI√ìN) ---
        document.getElementById('btn-open-manual').onclick = async () => {
            manualModal.classList.remove('hidden');
            manualItemsContainer.innerHTML = "";
            addManualItemRow(); // Iniciar con una fila
            // Cargar productos para el select si no est√°n cargados
            if(allProducts.length === 0){
                const pSnap = await getDocs(collection(db, "products"));
                pSnap.forEach(d => allProducts.push({id: d.id, ...d.data()}));
            }
        };

        function addManualItemRow() {
            const div = document.createElement('div');
            div.className = "flex gap-2 items-center bg-white p-3 rounded-2xl border border-gray-50";
            div.innerHTML = `
                <select class="m-item-select flex-grow bg-slate-50 border-none rounded-xl text-xs font-bold p-3 outline-none focus:ring-2 focus:ring-brand-cyan/20">
                    <option value="">Selecciona Producto...</option>
                    ${allProducts.map(p => `<option value="${p.id}" data-price="${p.price}" data-img="${p.image}" data-name="${p.name}">${p.name} - $${p.price.toLocaleString()}</option>`).join('')}
                </select>
                <input type="number" value="1" min="1" class="m-item-qty w-16 bg-slate-50 border-none rounded-xl text-xs font-black p-3 text-center outline-none">
                <button class="text-gray-300 hover:text-brand-red p-2" onclick="this.parentElement.remove(); calculateManualTotal();"><i class="fa-solid fa-trash-can"></i></button>
            `;
            manualItemsContainer.appendChild(div);
            div.querySelector('select').onchange = calculateManualTotal;
            div.querySelector('input').oninput = calculateManualTotal;
        }

        window.calculateManualTotal = () => {
            let total = 0;
            document.querySelectorAll('.m-item-select').forEach((sel, idx) => {
                const qty = document.querySelectorAll('.m-item-qty')[idx].value;
                const price = sel.options[sel.selectedIndex]?.dataset.price || 0;
                total += (price * qty);
            });
            document.getElementById('manual-total-display').textContent = `$${total.toLocaleString('es-CO')}`;
        };

        document.getElementById('btn-add-item-row').onclick = addManualItemRow;

        document.getElementById('btn-save-manual').onclick = async () => {
            const btn = document.getElementById('btn-save-manual');
            const name = document.getElementById('m-cust-name').value;
            const phone = document.getElementById('m-cust-phone').value;
            const itemSelects = document.querySelectorAll('.m-item-select');
            
            if(!name || itemSelects.length === 0) return alert("Completa los datos del cliente y productos");

            btn.disabled = true;
            btn.innerHTML = "Creando...";

            const items = [];
            itemSelects.forEach((sel, idx) => {
                const opt = sel.options[sel.selectedIndex];
                if(opt.value){
                    items.push({
                        id: opt.value,
                        name: opt.dataset.name,
                        price: parseFloat(opt.dataset.price),
                        image: opt.dataset.img,
                        quantity: parseInt(document.querySelectorAll('.m-item-qty')[idx].value)
                    });
                }
            });

            try {
                await addDoc(collection(db, "orders"), {
                    userName: name,
                    userEmail: phone, // Usamos el tel√©fono en el campo de email para remisiones manuales
                    items: items,
                    total: items.reduce((acc, i) => acc + (i.price * i.quantity), 0),
                    status: 'PENDIENTE',
                    source: 'DIRECTA', // Marca para saber que no es de la web
                    createdAt: new Date()
                });
                alert("Remisi√≥n Creada Correctamente");
                closeAll();
                fetchDashboardData();
            } catch (e) { alert(e.message); } finally { btn.disabled = false; btn.innerHTML = "Crear Remisi√≥n"; }
        };

        // --- L√ìGICA EXISTENTE DE PEDIDOS WEB ---
        window.viewOrderDetail = async (orderId) => {
            currentOrderId = orderId;
            try {
                const snap = await getDoc(doc(db, "orders", orderId));
                if (snap.exists()) {
                    const order = snap.data();
                    document.getElementById('modal-order-id').textContent = `#${snap.id.slice(0, 8).toUpperCase()}`;
                    document.getElementById('modal-order-date').textContent = order.createdAt.toDate().toLocaleString('es-CO');
                    document.getElementById('modal-client-name').textContent = order.userName || 'Cliente';
                    document.getElementById('modal-client-email').textContent = order.userEmail || order.phone;
                    document.getElementById('modal-order-total').textContent = `$${order.total.toLocaleString('es-CO')}`;

                    const badge = document.getElementById('modal-order-status-badge');
                    let bClass = "bg-yellow-100 text-yellow-700";
                    if(order.status === 'ALISTADO') bClass = "bg-blue-100 text-blue-700";
                    if(order.status === 'DESPACHADO') bClass = "bg-green-100 text-green-700";
                    badge.className = `px-3 py-1 rounded-full text-[10px] font-black uppercase border shadow-sm ${bClass}`;
                    badge.textContent = order.status || 'PENDIENTE';

                    document.getElementById('btn-save-alistado').classList.toggle('hidden', order.status === 'ALISTADO' || order.status === 'DESPACHADO');
                    document.getElementById('btn-set-despachado').classList.toggle('hidden', order.status !== 'ALISTADO');

                    itemsContainer.innerHTML = order.items.map((item, itemIdx) => {
                        let inputsHTML = '';
                        for(let i=0; i < item.quantity; i++){
                            const val = (item.sns && item.sns[i]) ? item.sns[i] : '';
                            inputsHTML += `
                                <div class="relative group mb-2 last:mb-0">
                                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-[9px] font-black text-gray-300">${i+1}</span>
                                    <input type="text" placeholder="Serial (SN)" value="${val}"
                                        data-item-index="${itemIdx}" data-unit-index="${i}"
                                        class="sn-input w-full bg-slate-50 border border-gray-200 rounded-lg py-2 pl-7 pr-3 text-[11px] font-mono focus:border-brand-cyan outline-none transition"
                                        ${order.status === 'DESPACHADO' ? 'disabled' : ''}>
                                </div>`;
                        }
                        return `
                        <div class="grid grid-cols-1 md:grid-cols-12 gap-4 p-5 md:px-6 md:py-6 border-b border-gray-50 last:border-0">
                            <div class="md:col-span-7 flex items-center gap-4">
                                <div class="w-14 h-14 rounded-xl border border-gray-100 bg-white p-1 shrink-0"><img src="${item.image}" class="w-full h-full object-contain"></div>
                                <div><p class="font-black text-brand-black text-xs md:text-sm">${item.name}</p><p class="text-[10px] font-bold text-brand-cyan uppercase">Cantidad: ${item.quantity}</p></div>
                            </div>
                            <div class="md:col-span-5 flex flex-col justify-center">${inputsHTML}</div>
                        </div>`;
                    }).join('');
                    modal.classList.remove('hidden');
                }
            } catch (e) { console.error(e); }
        };

        document.getElementById('btn-save-alistado').onclick = async () => {
            const btn = document.getElementById('btn-save-alistado');
            btn.disabled = true;
            try {
                const snap = await getDoc(doc(db, "orders", currentOrderId));
                const updatedItems = snap.data().items.map((item, idx) => {
                    const inputs = document.querySelectorAll(`.sn-input[data-item-index="${idx}"]`);
                    return { ...item, sns: Array.from(inputs).map(i => i.value.trim()) };
                });
                await updateDoc(doc(db, "orders", currentOrderId), { items: updatedItems, status: 'ALISTADO' });
                alert("Alistamiento Guardado");
                closeAll(); fetchDashboardData();
            } catch (e) { alert(e.message); } finally { btn.disabled = false; }
        };

        document.getElementById('btn-set-despachado').onclick = () => dispatchModal.classList.remove('hidden');

        document.getElementById('btn-confirm-dispatch').onclick = async () => {
            const carrier = document.getElementById('dispatch-carrier').value;
            const tracking = document.getElementById('dispatch-tracking').value;
            if(!carrier || !tracking) return alert("Completa los datos");
            try {
                await updateDoc(doc(db, "orders", currentOrderId), {
                    status: 'DESPACHADO',
                    shippingCarrier: carrier,
                    shippingTracking: tracking,
                    shippedAt: new Date()
                });
                alert("Pedido Despachado üöö");
                closeAll(); fetchDashboardData();
            } catch (e) { alert(e.message); }
        };

        async function fetchDashboardData() {
            const tableBody = document.getElementById('orders-table-body');
            const snapshot = await getDocs(query(collection(db, "orders"), orderBy("createdAt", "desc"), limit(20)));
            const users = await getDocs(collection(db, "users"));
            
            document.getElementById('stat-users').textContent = users.size;
            document.getElementById('stat-orders').textContent = snapshot.size;
            tableBody.innerHTML = "";
            let income = 0;

            snapshot.forEach(d => {
                const o = d.data(); income += (o.total || 0);
                const isPaid = o.status === 'PAID', isAlistado = o.status === 'ALISTADO', isDespachado = o.status === 'DESPACHADO';
                let sClass = 'bg-yellow-100 text-yellow-700', sText = 'Pendiente';
                if(isPaid){ sClass='bg-emerald-100 text-emerald-700'; sText='Pagado'; }
                if(isAlistado){ sClass='bg-blue-100 text-blue-700'; sText='Alistado'; }
                if(isDespachado){ sClass='bg-green-100 text-green-700'; sText='Despachado'; }

                const sourceTag = o.source === 'DIRECTA' ? 
                    `<span class="ml-2 text-[8px] bg-slate-200 text-slate-600 px-1.5 py-0.5 rounded-md font-black italic">DIRECTA</span>` : 
                    `<span class="ml-2 text-[8px] bg-brand-cyan/10 text-brand-cyan px-1.5 py-0.5 rounded-md font-black italic">TIENDA</span>`;

                tableBody.innerHTML += `
                <tr class="hover:bg-slate-50 transition border-b border-gray-50">
                    <td class="px-6 py-4">
                        <div class="font-mono text-[10px] text-gray-400">#${d.id.slice(0,8).toUpperCase()}</div>
                        ${sourceTag}
                    </td>
                    <td class="px-6 py-4"><div class="font-bold text-brand-black">${o.userName || 'Cliente'}</div><div class="text-[10px] text-gray-400">${o.userEmail || o.phone || ''}</div></td>
                    <td class="px-6 py-4 text-gray-500 text-xs">${o.createdAt.toDate().toLocaleDateString('es-CO')}</td>
                    <td class="px-6 py-4"><span class="${sClass} px-3 py-1 rounded-full text-[9px] font-black uppercase border shadow-sm">${sText}</span></td>
                    <td class="px-6 py-4 text-right font-black text-brand-black">$${(o.total || 0).toLocaleString('es-CO')}</td>
                    <td class="px-6 py-4 text-center">
                        <button onclick="window.viewOrderDetail('${d.id}')" class="w-9 h-9 rounded-xl bg-slate-100 text-slate-400 hover:bg-brand-cyan hover:text-white transition-all shadow-sm flex items-center justify-center mx-auto"><i class="fa-solid fa-eye text-xs"></i></button>
                    </td>
                </tr>`;
            });
            document.getElementById('stat-sales').textContent = new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits:0 }).format(income);
        }

        fetchDashboardData();
    </script>
</body>

</html>