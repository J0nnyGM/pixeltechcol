<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entrada de Mercancía | PixelTech Admin</title>
    <link rel="stylesheet" href="../css/styles.css">
    <script src="https://kit.fontawesome.com/0d623ded97.js" crossorigin="anonymous"></script>
    <style>
        .hidden {
            display: none !important;
        }

        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #00AEC7;
            border-radius: 10px;
        }

        .fade-in {
            animation: fadeIn 0.4s ease-out forwards;
            opacity: 0;
            transform: translateY(10px);
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body
    class="bg-slate-50 font-sans text-brand-black flex h-screen overflow-hidden selection:bg-brand-cyan selection:text-white">

    <div id="admin-sidebar"></div>

    <main class="flex-grow overflow-y-auto relative custom-scroll">
        <header
            class="bg-white/90 backdrop-blur-xl border-b border-gray-100 px-8 py-5 flex justify-between items-center sticky top-0 z-40 shadow-sm">
            <div>
                <h2 class="font-black text-gray-400 text-[9px] uppercase tracking-[0.4em]">Logística & Abastecimiento
                </h2>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-right hidden md:block">
                    <span id="admin-name"
                        class="text-xs font-black text-brand-black uppercase tracking-widest block">Administrador</span>
                    <span class="text-[8px] font-bold text-gray-400 uppercase tracking-widest">Sesión Activa</span>
                </div>
                <div
                    class="w-10 h-10 bg-brand-black text-white rounded-xl flex items-center justify-center font-bold shadow-lg">
                    <i class="fa-solid fa-boxes-stacked"></i>
                </div>
            </div>
        </header>

        <div class="p-8 max-w-7xl mx-auto text-left pb-40">
            <div class="mb-10 flex flex-col md:flex-row justify-between items-end gap-6">
                <div>
                    <h1
                        class="text-4xl lg:text-5xl font-black text-brand-black tracking-tighter uppercase leading-none">
                        Entrada de <br><span class="text-brand-cyan">Mercancía</span></h1>
                    <p class="text-gray-400 text-sm font-bold mt-2 tracking-wide">Gestión de compras, costos e
                        incremento de stock.</p>
                </div>
                <div
                    class="bg-blue-50 text-blue-800 px-6 py-4 rounded-2xl text-xs font-bold border border-blue-100 shadow-sm max-w-sm">
                    <i class="fa-solid fa-circle-info mr-2"></i>
                    Recuerda que al procesar la entrada, el stock se sumará automáticamente y se recalculará el costo
                    promedio.
                </div>
            </div>

            <div
                class="bg-white p-8 rounded-[2.5rem] border border-gray-100 shadow-sm mb-8 group hover:shadow-lg transition-all duration-300 fade-in relative z-30">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-8 h-8 rounded-full bg-brand-cyan/10 flex items-center justify-center text-brand-cyan">
                        <i class="fa-solid fa-truck-field"></i>
                    </div>
                    <label class="text-[10px] font-black text-gray-400 uppercase tracking-[0.2em]">Proveedor de la
                        Factura</label>
                </div>

                <div class="relative">
                    <i class="fa-solid fa-magnifying-glass absolute left-6 top-1/2 -translate-y-1/2 text-gray-300"></i>
                    <input type="text" id="supplier-search" placeholder="Buscar aliado comercial..."
                        class="w-full bg-slate-50 border-2 border-transparent rounded-2xl py-4 pl-14 pr-6 text-sm font-black text-gray-600 outline-none focus:bg-white focus:border-brand-cyan/30 focus:text-brand-black transition-all">

                    <div id="supplier-results"
                        class="absolute left-0 top-full mt-2 w-full bg-white border border-gray-100 rounded-2xl shadow-2xl max-h-60 overflow-y-auto hidden z-50 p-2 custom-scroll">
                    </div>
                    <input type="hidden" id="entry-supplier-id">
                </div>
            </div>

            <div class="bg-white rounded-[3rem] shadow-xl border border-gray-100 overflow-visible mb-10 fade-in relative z-20"
                style="animation-delay: 100ms;">
                <div
                    class="p-8 border-b border-gray-50 flex justify-between items-center bg-slate-50/50 rounded-t-[3rem]">
                    <h3
                        class="font-black text-brand-black uppercase text-[11px] tracking-widest flex items-center gap-3">
                        <span class="w-2 h-2 rounded-full bg-brand-cyan shadow-[0_0_10px_#00AEC7]"></span> Equipos
                        Recibidos
                    </h3>
                    <button id="btn-add-item-row"
                        class="bg-brand-black text-white px-6 py-3 rounded-xl font-black text-[10px] uppercase tracking-widest hover:bg-brand-cyan hover:text-brand-black transition-all shadow-lg hover:shadow-cyan-500/20 transform active:scale-95 flex items-center gap-2">
                        <i class="fa-solid fa-plus"></i> Añadir Linea
                    </button>
                </div>

                <div id="entry-items-container" class="p-8 space-y-4 bg-white min-h-[200px]"></div>

                <div class="p-10 bg-slate-900 text-white mt-4 relative overflow-hidden rounded-b-[3rem]">
                    <div
                        class="absolute top-0 right-0 w-64 h-64 bg-brand-cyan/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none">
                    </div>

                    <div class="flex flex-col lg:flex-row justify-between items-center gap-10 relative z-10">
                        <div
                            class="flex items-center gap-6 bg-white/5 p-4 rounded-2xl border border-white/10 backdrop-blur-sm">
                            <label for="global-iva-toggle" class="flex items-center cursor-pointer relative">
                                <input type="checkbox" id="global-iva-toggle" class="sr-only peer">
                                <div
                                    class="w-14 h-8 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-7 after:w-7 after:transition-all peer-checked:bg-brand-cyan">
                                </div>
                            </label>
                            <div>
                                <p class="text-[10px] font-black uppercase text-white tracking-widest">Aplicar IVA (19%)
                                </p>
                                <p class="text-[8px] font-bold text-white/40 uppercase mt-0.5">Calcula base + impuestos
                                </p>
                            </div>
                        </div>

                        <div class="flex flex-wrap justify-end gap-8 md:gap-12 text-right">
                            <div>
                                <p class="text-[9px] font-black text-white/40 uppercase tracking-widest mb-1">Base Neta
                                </p>
                                <h4 id="display-base" class="text-xl font-bold text-white/80">$0</h4>
                            </div>
                            <div>
                                <p class="text-[9px] font-black text-brand-cyan uppercase tracking-widest mb-1">IVA
                                    Calculado</p>
                                <h4 id="display-iva" class="text-xl font-bold text-brand-cyan">$0</h4>
                            </div>
                            <div class="pl-8 md:pl-12 border-l border-white/10">
                                <p class="text-[9px] font-black text-white/40 uppercase tracking-widest mb-1">Total
                                    Factura</p>
                                <h3 id="display-grand-total"
                                    class="text-4xl font-black text-white leading-none tracking-tight">$0</h3>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 flex justify-end">
                        <button id="btn-save-entry"
                            class="w-full md:w-auto bg-brand-cyan text-brand-black px-12 py-5 rounded-2xl font-black text-[11px] uppercase tracking-[0.2em] shadow-[0_0_20px_rgba(0,174,199,0.3)] hover:bg-white hover:shadow-white/20 transition-all duration-300 transform active:scale-95">
                            Procesar Entrada de Inventario
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

<script type="module">
        import { db, collection, getDocs, doc, runTransaction, orderBy, query } from '../js/firebase-init.js';
        import { loadAdminSidebar } from '../js/admin-ui.js';

        loadAdminSidebar();

        const supplierSearchInput = document.getElementById('supplier-search');
        const supplierResults = document.getElementById('supplier-results');
        const supplierIdField = document.getElementById('entry-supplier-id');
        const itemsContainer = document.getElementById('entry-items-container');
        const btnSave = document.getElementById('btn-save-entry');
        const ivaToggle = document.getElementById('global-iva-toggle');

        let allProducts = [];
        let allSuppliers = [];

        // --- CARGA INICIAL ---
        async function fetchSuppliers() {
            try {
                const snap = await getDocs(query(collection(db, "suppliers"), orderBy("name", "asc")));
                allSuppliers = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            } catch (e) { console.error("Error proveedores:", e); }
        }

        async function fetchProducts() {
            try {
                const snap = await getDocs(collection(db, "products"));
                allProducts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            } catch (e) { console.error("Error productos:", e); }
        }

        // --- UI BUSCADOR ---
        supplierSearchInput.oninput = (e) => {
            const term = e.target.value.toLowerCase();
            supplierResults.innerHTML = "";
            supplierIdField.value = "";
            if (term.length < 1) { supplierResults.classList.add('hidden'); return; }
            const filtered = allSuppliers.filter(s => s.name.toLowerCase().includes(term) || (s.nit && s.nit.includes(term)));
            if (filtered.length === 0) {
                supplierResults.innerHTML = `<div class="p-3 text-xs text-gray-400 font-bold text-center">No se encontraron proveedores</div>`;
            } else {
                filtered.forEach(s => {
                    const div = document.createElement('div');
                    div.className = "p-3 hover:bg-brand-cyan/5 cursor-pointer border-b border-gray-50 last:border-0 rounded-lg flex justify-between items-center transition-colors";
                    div.innerHTML = `<div><p class="text-[11px] font-black uppercase text-brand-black">${s.name}</p><p class="text-[9px] font-bold text-gray-400">NIT: ${s.nit || '---'}</p></div><i class="fa-solid fa-check text-brand-cyan text-xs opacity-0 group-hover:opacity-100"></i>`;
                    div.onclick = () => {
                        supplierSearchInput.value = s.name;
                        supplierIdField.value = s.id;
                        supplierResults.classList.add('hidden');
                    };
                    supplierResults.appendChild(div);
                });
            }
            supplierResults.classList.remove('hidden');
        };

        document.addEventListener('click', (e) => {
            if (!supplierSearchInput.contains(e.target) && !supplierResults.contains(e.target)) {
                supplierResults.classList.add('hidden');
            }
        });

        // --- CÁLCULOS TOTALES UI ---
        window.updateAllTotals = () => {
            let grandTotal = 0;
            document.querySelectorAll('.item-row').forEach(row => {
                const qty = parseInt(row.querySelector('.p-qty').value) || 0;
                const unitCost = parseFloat(row.querySelector('.p-unit-cost-input').value) || 0;
                const rowTotal = qty * unitCost;
                row.querySelector('.p-row-total-display').textContent = `$${Math.round(rowTotal).toLocaleString('es-CO')}`;
                grandTotal += rowTotal;
            });
            const hasIva = ivaToggle.checked;
            const base = hasIva ? Math.round(grandTotal / 1.19) : grandTotal;
            const iva = grandTotal - base;
            document.getElementById('display-grand-total').textContent = `$${Math.round(grandTotal).toLocaleString('es-CO')}`;
            document.getElementById('display-base').textContent = `$${Math.round(base).toLocaleString('es-CO')}`;
            document.getElementById('display-iva').textContent = `$${Math.round(iva).toLocaleString('es-CO')}`;
        };

        // --- FILAS DE PRODUCTOS ---
        function addProductRow() {
            const div = document.createElement('div');
            div.className = "item-row bg-slate-50 p-5 rounded-[2rem] border border-gray-100 relative group hover:bg-white hover:shadow-lg hover:border-brand-cyan/30 transition-all duration-300 fade-in z-10";
            div.onmouseenter = () => div.style.zIndex = "50";
            div.onmouseleave = () => div.style.zIndex = "10";
            div.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                    <div class="md:col-span-4 relative">
                        <label class="text-[8px] font-black text-gray-400 uppercase mb-2 block tracking-widest ml-1">Producto / Equipo</label>
                        <div class="relative"><i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-gray-300 text-xs z-10"></i><input type="text" placeholder="Buscar..." class="p-search w-full bg-white border border-gray-200 rounded-xl py-3 pl-10 pr-4 text-xs font-bold outline-none focus:border-brand-cyan focus:ring-4 focus:ring-cyan-500/10 transition-all"></div>
                        <div class="p-results absolute z-[100] w-full mt-2 bg-white border border-gray-100 rounded-xl shadow-2xl hidden max-h-60 overflow-y-auto p-2 custom-scroll"></div>
                        <input type="hidden" class="p-id">
                    </div>
                    <div class="md:col-span-3 flex gap-2 p-variants-container">
                        <div class="w-full h-[42px] bg-gray-100/50 rounded-xl border border-dashed border-gray-300 flex items-center justify-center text-[9px] text-gray-400 uppercase font-bold">Selecciona un producto</div>
                    </div>
                    <div class="md:col-span-1">
                        <label class="text-[8px] font-black text-gray-400 uppercase mb-2 block text-center tracking-widest">Cant.</label>
                        <input type="number" value="1" min="1" class="p-qty w-full h-[42px] bg-white border border-gray-200 rounded-xl px-2 text-xs font-black text-center outline-none focus:border-brand-cyan transition-all">
                    </div>
                    <div class="md:col-span-2">
                        <label class="text-[8px] font-black text-gray-400 uppercase mb-2 block tracking-widest ml-1">Costo Unitario</label>
                        <div class="flex items-center bg-white border border-gray-200 rounded-xl px-3 h-[42px] focus-within:border-brand-cyan focus-within:ring-4 focus-within:ring-cyan-500/10 transition-all"><span class="text-xs font-black text-gray-400 mr-2">$</span><input type="number" placeholder="0" class="p-unit-cost-input w-full bg-transparent border-none text-xs font-black outline-none text-brand-black h-full"></div>
                    </div>
                    <div class="md:col-span-2 flex items-center justify-between pl-2 h-[42px]">
                         <div class="flex flex-col justify-center h-full"><label class="text-[8px] font-black text-gray-300 uppercase leading-none mb-1">Subtotal</label><span class="text-sm font-black text-brand-black p-row-total-display leading-none">$0</span></div>
                        <button class="w-9 h-9 rounded-xl bg-white border border-gray-200 text-gray-300 hover:text-brand-red hover:border-brand-red hover:bg-red-50 transition-all flex items-center justify-center shadow-sm" onclick="window.removeEntryRow(this)"><i class="fa-solid fa-trash-can text-xs"></i></button>
                    </div>
                </div>`;
            itemsContainer.appendChild(div);
            setupRowLogic(div);
        }

        window.removeEntryRow = (btn) => {
            const row = btn.closest('.item-row');
            row.style.opacity = '0';
            setTimeout(() => { row.remove(); window.updateAllTotals(); }, 300);
        };

        function setupRowLogic(row) {
            const input = row.querySelector('.p-search');
            const results = row.querySelector('.p-results');
            const qtyInput = row.querySelector('.p-qty');
            const unitCostInput = row.querySelector('.p-unit-cost-input');

            input.oninput = (e) => {
                const term = e.target.value.toLowerCase();
                results.innerHTML = "";
                if (term.length < 1) { results.classList.add('hidden'); return; }
                const filtered = allProducts.filter(p => p.name.toLowerCase().includes(term));
                if (filtered.length === 0) { results.innerHTML = `<div class="p-3 text-[10px] text-gray-400 font-bold text-center">No encontrado</div>`; }
                filtered.forEach(p => {
                    const d = document.createElement('div');
                    d.className = "p-3 hover:bg-slate-50 cursor-pointer text-[10px] font-black uppercase rounded-lg border-b border-gray-50 last:border-0 transition-colors flex justify-between items-center";
                    d.innerHTML = `<span>${p.name}</span> <i class="fa-solid fa-plus text-brand-cyan"></i>`;
                    d.onclick = () => {
                        input.value = p.name;
                        row.querySelector('.p-id').value = p.id;
                        renderVariants(row, p);
                        results.classList.add('hidden');
                        if (p.lastPurchaseCost) {
                            row.querySelector('.p-unit-cost-input').value = p.lastPurchaseCost;
                            window.updateAllTotals();
                        }
                    };
                    results.appendChild(d);
                });
                results.classList.remove('hidden');
            };
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !results.contains(e.target)) results.classList.add('hidden');
            });
            qtyInput.oninput = window.updateAllTotals;
            unitCostInput.oninput = window.updateAllTotals;
        }

        function renderVariants(row, product) {
            const container = row.querySelector('.p-variants-container');
            container.innerHTML = "";
            
            // Lógica de Variantes Robusta (Merge de estructuras viejas y nuevas)
            let colors = [];
            if (product.definedColors) colors = product.definedColors;
            else if (product.variants) colors = product.variants.map(v => v.color);
            colors = [...new Set(colors)];

            let caps = [];
            if (product.definedCapacities) caps = product.definedCapacities;
            else if (product.capacities) caps = product.capacities.map(c => c.label);
            caps = [...new Set(caps)];

            if (colors.length === 0 && caps.length === 0) {
                container.innerHTML = `<div class="w-full h-[42px] flex items-center pl-2"><span class="text-[9px] font-bold text-gray-300 uppercase bg-gray-50 px-2 py-1 rounded">Producto Único</span></div>`;
                return;
            }

            if (colors.length > 0) {
                const wrap = document.createElement('div');
                wrap.className = "flex-1";
                wrap.innerHTML = `<label class="text-[8px] font-black text-gray-400 uppercase mb-2 block tracking-widest ml-1">Color</label><select class="variant-select p-color w-full bg-white border border-gray-200 rounded-xl px-2 h-[42px] text-xs font-bold outline-none focus:border-brand-cyan"><option value="">Selecciona</option>${colors.map(c => `<option value="${c}">${c}</option>`).join('')}</select>`;
                container.appendChild(wrap);
            }
            if (caps.length > 0) {
                const wrap = document.createElement('div');
                wrap.className = "flex-1";
                wrap.innerHTML = `<label class="text-[8px] font-black text-gray-400 uppercase mb-2 block tracking-widest ml-1">Capacidad</label><select class="variant-select p-capacity w-full bg-white border border-gray-200 rounded-xl px-2 h-[42px] text-xs font-bold outline-none focus:border-brand-cyan"><option value="">Selecciona</option>${caps.map(c => `<option value="${c}">${c}</option>`).join('')}</select>`;
                container.appendChild(wrap);
            }
        }

        ivaToggle.onchange = window.updateAllTotals;

        // --- LÓGICA DE GUARDADO (AGRUPADA Y ESTRICTA) ---
        btnSave.onclick = async () => {
            const supplierId = supplierIdField.value;
            const itemRows = document.querySelectorAll('.item-row');

            if (!supplierId) return alert("⚠️ Seleccione un proveedor válido.");
            if (itemRows.length === 0) return alert("⚠️ Agregue al menos un producto.");

            const originalText = btnSave.innerHTML;
            btnSave.disabled = true;
            btnSave.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> PROCESANDO...';

            try {
                // 1. Recopilar y Agrupar por ID de Producto
                const groupedItems = {}; // { pid: { name, updates: [ {qty, color, cap, cost} ] } }

                for (const row of itemRows) {
                    const pid = row.querySelector('.p-id').value;
                    if (!pid) continue;

                    const qty = parseInt(row.querySelector('.p-qty').value);
                    const unitCostEntered = parseFloat(row.querySelector('.p-unit-cost-input').value);
                    const selectedColor = row.querySelector('.p-color')?.value || null;
                    const selectedCap = row.querySelector('.p-capacity')?.value || null;
                    const name = row.querySelector('.p-search').value;

                    if (!qty || qty <= 0) throw "Cantidad inválida en una fila";
                    if (isNaN(unitCostEntered)) throw "Costo inválido en una fila";

                    // Validar selección obligatoria
                    if (row.querySelector('.p-color') && !selectedColor) throw `⚠️ Selecciona un color para: ${name}`;
                    if (row.querySelector('.p-capacity') && !selectedCap) throw `⚠️ Selecciona una capacidad para: ${name}`;

                    if (!groupedItems[pid]) groupedItems[pid] = { name, updates: [] };
                    
                    groupedItems[pid].updates.push({
                        qty,
                        unitCostEntered,
                        selectedColor, // Puede ser null
                        selectedCap,   // Puede ser null
                        name
                    });
                }

                await runTransaction(db, async (transaction) => {
                    const suppRef = doc(db, "suppliers", supplierId);
                    const suppSnap = await transaction.get(suppRef);
                    if (!suppSnap.exists()) throw "Proveedor no encontrado";

                    // Leer productos únicos
                    const uniquePids = Object.keys(groupedItems);
                    const productReads = uniquePids.map(pid => transaction.get(doc(db, "products", pid)));
                    const productSnaps = await Promise.all(productReads);

                    let totalInvoice = 0;
                    const purchaseItems = [];
                    const hasIvaGlobal = ivaToggle.checked;

                    // Procesar cada producto ÚNICO (para no sobrescribir lecturas)
                    uniquePids.forEach((pid, index) => {
                        const pSnap = productSnaps[index];
                        if (!pSnap.exists()) throw `Producto no encontrado`;

                        const pData = pSnap.data();
                        const pRef = doc(db, "products", pid);
                        const group = groupedItems[pid];

                        let combinations = pData.combinations ? [...pData.combinations] : [];
                        let lastCost = pData.lastPurchaseCost;
                        let additionalStockTotal = 0;

                        // Aplicar TODAS las actualizaciones de este producto en memoria
                        group.updates.forEach(update => {
                            const rowTotal = update.qty * update.unitCostEntered;
                            totalInvoice += rowTotal;
                            const unitCostBase = hasIvaGlobal ? Math.round(update.unitCostEntered / 1.19) : update.unitCostEntered;
                            lastCost = unitCostBase;
                            additionalStockTotal += update.qty;

                            // Lógica de Matriz Estricta
                            if (update.selectedColor || update.selectedCap) {
                                // Búsqueda estricta: Ambos deben coincidir (o ser ambos nulos)
                                const comboIndex = combinations.findIndex(c => {
                                    const colorMatch = (c.color || "") === (update.selectedColor || "");
                                    const capMatch = (c.capacity || "") === (update.selectedCap || "");
                                    return colorMatch && capMatch;
                                });

                                if (comboIndex >= 0) {
                                    // Existe la combinación exacta: Sumar
                                    combinations[comboIndex].stock = (parseInt(combinations[comboIndex].stock) || 0) + update.qty;
                                } else {
                                    // No existe esta combinación específica: Crear
                                    combinations.push({
                                        color: update.selectedColor,
                                        capacity: update.selectedCap,
                                        stock: update.qty,
                                        price: pData.price // Hereda precio base
                                    });
                                }
                            }

                            // Historial de items comprados
                            purchaseItems.push({
                                id: pid,
                                name: update.name,
                                quantity: update.qty,
                                unitCostBase,
                                totalRow: Math.round(rowTotal),
                                color: update.selectedColor,
                                capacity: update.selectedCap
                            });
                        });

                        // Calcular Nuevo Stock Total
                        let newStockTotal = 0;
                        if (combinations.length > 0) {
                            newStockTotal = combinations.reduce((sum, i) => sum + (parseInt(i.stock) || 0), 0);
                        } else {
                            // Si es simple, sumamos lo que había + todo lo nuevo de este grupo
                            newStockTotal = (parseInt(pData.stock) || 0) + additionalStockTotal;
                        }

                        // Actualizar Producto UNA VEZ por transacción
                        transaction.update(pRef, {
                            stock: newStockTotal,
                            combinations: combinations,
                            lastPurchaseCost: lastCost,
                            updatedAt: new Date()
                        });
                    });

                    const finalTotal = Math.round(totalInvoice);

                    // Actualizar Proveedor
                    transaction.update(suppRef, {
                        totalInvested: (suppSnap.data().totalInvested || 0) + finalTotal,
                        ordersCount: (suppSnap.data().ordersCount || 0) + 1,
                        lastPurchase: new Date()
                    });

                    // Crear Compra
                    const purchaseRef = doc(collection(db, "purchases"));
                    transaction.set(purchaseRef, {
                        supplierId,
                        supplierName: supplierSearchInput.value,
                        totalCost: finalTotal,
                        amountPaid: 0,
                        hasIVA: hasIvaGlobal,
                        items: purchaseItems,
                        createdAt: new Date(),
                        createdBy: document.getElementById('admin-name').innerText
                    });

                    // Crear CxP
                    const payableRef = doc(collection(db, "payables"));
                    transaction.set(payableRef, {
                        provider: supplierSearchInput.value,
                        description: `Compra Inv. #${purchaseRef.id.slice(0,6).toUpperCase()}`,
                        total: finalTotal,
                        amountPaid: 0,
                        balance: finalTotal,
                        status: 'PENDING',
                        dueDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        createdAt: new Date(),
                        purchaseId: purchaseRef.id
                    });
                });

                alert("✅ Inventario actualizado correctamente.");
                window.location.reload();

            } catch (e) {
                console.error(e);
                alert("Error crítico: " + e);
                btnSave.disabled = false;
                btnSave.innerHTML = originalText;
            }
        };

        fetchSuppliers();
        fetchProducts();
        addProductRow();

        document.getElementById('btn-add-item-row').onclick = addProductRow;
    </script>
</body>

</html>