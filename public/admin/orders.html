<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Pedidos - PixelTech</title>
    <link rel="stylesheet" href="../css/styles.css">
    <script src="https://kit.fontawesome.com/0d623ded97.js" crossorigin="anonymous"></script>
    <style>
        .hidden { display: none !important; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #00AEC7; border-radius: 10px; }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; opacity: 0; transform: translateY(5px); }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
        .tab-btn.active { background-color: #00AEC7; color: white; box-shadow: 0 4px 12px rgba(0, 174, 199, 0.3); border-color: transparent; }
        .tab-btn { background-color: white; color: #111827; border: 1px solid #e5e7eb; font-weight: 900; }
    </style>
</head>

<body class="bg-slate-50 font-sans text-brand-black flex h-screen overflow-hidden selection:bg-brand-cyan selection:text-white">

    <div id="admin-sidebar"></div>

    <main class="flex-grow overflow-y-auto relative custom-scroll">
        <header class="bg-white/90 backdrop-blur-xl border-b border-gray-100 px-8 py-4 flex justify-between items-center sticky top-0 z-20 shadow-sm">
            <h2 class="font-black text-brand-black text-[9px] uppercase tracking-[0.3em]">Centro Logístico</h2>
            <div class="flex items-center gap-4">
                <button id="btn-open-manual" class="bg-brand-black text-white px-6 py-2.5 rounded-xl font-black text-[10px] uppercase tracking-widest hover:bg-brand-cyan hover:text-brand-black hover:shadow-lg transition-all flex items-center gap-2 transform active:scale-95">
                    <i class="fa-solid fa-plus"></i> Nueva Venta
                </button>
                <div class="w-10 h-10 bg-slate-100 text-brand-cyan rounded-xl flex items-center justify-center font-bold shadow-sm"><i class="fa-solid fa-user-shield"></i></div>
            </div>
        </header>

        <div class="p-8 max-w-[1600px] mx-auto pb-20">
            <div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-6">
                <div>
                    <h1 class="text-4xl font-black tracking-tighter text-brand-black uppercase leading-none mb-2">Pedidos & <span class="text-brand-cyan">Envíos</span></h1>
                    <p class="text-sm text-brand-black font-bold tracking-wide">Administra el flujo de ventas y despachos.</p>
                </div>
                <div class="relative w-full md:w-auto">
                    <i class="fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-brand-black text-xs"></i>
                    <input type="text" id="search-input" placeholder="Buscar por ID o Cliente..." class="w-full md:w-64 pl-10 pr-4 py-3 rounded-xl border border-gray-200 text-xs font-bold outline-none focus:border-brand-cyan transition bg-white shadow-sm text-brand-black">
                </div>
            </div>

            <div class="flex flex-wrap gap-3 mb-8">
                <button onclick="window.switchTab('ACTIONABLE')" id="tab-actionable" class="tab-btn active px-6 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all flex items-center gap-2"><i class="fa-solid fa-bell"></i> Por Atender</button>
                <button onclick="window.switchTab('WAITING')" id="tab-waiting" class="tab-btn px-6 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all flex items-center gap-2"><i class="fa-solid fa-clock"></i> En Espera</button>
                <button onclick="window.switchTab('DISPATCHED')" id="tab-dispatched" class="tab-btn px-6 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all flex items-center gap-2"><i class="fa-solid fa-truck-fast"></i> Enviados</button>
                <button onclick="window.switchTab('FAILED')" id="tab-failed" class="tab-btn px-6 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all flex items-center gap-2"><i class="fa-solid fa-ban"></i> Cancelados</button>
                <button onclick="window.switchTab('ALL')" id="tab-all" class="tab-btn px-6 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all flex items-center gap-2"><i class="fa-solid fa-list"></i> Todo</button>
            </div>

            <div class="bg-white rounded-[2.5rem] shadow-xl border border-gray-100 overflow-hidden fade-in">
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm min-w-[900px]">
                        <thead class="bg-slate-50 text-[9px] uppercase font-black text-brand-black tracking-widest border-b border-gray-100">
                            <tr>
                                <th class="px-8 py-6 w-32">ID / Fecha</th>
                                <th class="px-8 py-6">Cliente</th>
                                <th class="px-8 py-6 text-center">Canal</th>
                                <th class="px-8 py-6 text-center">Estado Pago</th>
                                <th class="px-8 py-6 text-center">Logística</th>
                                <th class="px-8 py-6 text-right">Total</th>
                                <th class="px-8 py-6 text-center w-40">Acciones</th> </tr>
                        </thead>
                        <tbody id="orders-table-body" class="divide-y divide-gray-50"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <div id="order-modal" class="fixed inset-0 z-[70] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-md transition-opacity" onclick="document.getElementById('order-modal').classList.add('hidden')"></div>
        <div class="relative bg-white w-full max-w-5xl rounded-[2.5rem] shadow-2xl flex flex-col max-h-[90vh] overflow-hidden animate-fadeIn">
            <div class="p-8 border-b border-gray-50 flex justify-between items-center bg-slate-50/50">
                <div class="flex items-center gap-6">
                    <div id="modal-source-icon"></div>
                    <div>
                        <div class="flex items-center gap-3">
                            <h3 class="text-3xl font-black tracking-tighter uppercase text-brand-black" id="modal-order-id">#ORDEN</h3>
                            <span id="modal-order-status-badge">...</span>
                        </div>
                        <p id="modal-order-date" class="text-[10px] font-bold text-brand-black uppercase tracking-widest mt-1">...</p>
                    </div>
                </div>
                <button class="w-10 h-10 rounded-full bg-white border border-gray-200 text-brand-black hover:bg-brand-red hover:text-white transition flex items-center justify-center" onclick="document.getElementById('order-modal').classList.add('hidden')"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-8 overflow-y-auto custom-scroll space-y-8 bg-white">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 space-y-6">
                        <div class="bg-white border border-gray-100 p-6 rounded-[2rem] shadow-sm">
                            <h4 class="text-[9px] font-black uppercase tracking-[0.2em] text-brand-black mb-4 flex items-center gap-2"><i class="fa-solid fa-user-tag text-brand-cyan"></i> Cliente</h4>
                            <p id="modal-client-name" class="font-black text-brand-black uppercase text-sm mb-1">...</p>
                            <p id="modal-client-doc" class="text-[10px] font-bold text-brand-black uppercase mb-1">...</p>
                            <p id="modal-client-contact" class="text-xs text-brand-black font-bold break-all">...</p>
                        </div>
                        <div class="bg-white border border-gray-100 p-6 rounded-[2rem] shadow-sm">
                            <h4 class="text-[9px] font-black uppercase tracking-[0.2em] text-brand-black mb-4 flex items-center gap-2"><i class="fa-solid fa-map-location-dot text-brand-cyan"></i> Envío</h4>
                            <p id="modal-delivery-address" class="text-xs font-bold text-brand-black mb-1">...</p>
                            <p id="modal-delivery-city" class="text-[10px] text-brand-black font-black uppercase">...</p>
                            <div id="modal-order-notes" class="mt-4 p-4 bg-yellow-50 rounded-xl text-[10px] text-yellow-900 font-bold border border-yellow-100 hidden"><i class="fa-regular fa-note-sticky mr-1"></i> <span id="note-text"></span></div>
                        </div>
                        <div id="modal-billing-section" class="hidden bg-brand-cyan/5 border border-brand-cyan/10 p-6 rounded-[2rem]">
                            <h4 class="text-[9px] font-black uppercase tracking-[0.2em] text-brand-cyan mb-4 flex items-center gap-2"><i class="fa-solid fa-file-invoice-dollar"></i> Facturación</h4>
                            <div class="space-y-2 text-xs font-bold text-brand-black"><p id="bill-modal-name">--</p><p id="bill-modal-id">--</p><p id="bill-modal-email" class="break-all">--</p></div>
                        </div>
                    </div>
                    <div class="lg:col-span-2">
                         <h4 class="text-[9px] font-black uppercase tracking-[0.2em] text-brand-black mb-4 flex items-center gap-2"><i class="fa-solid fa-boxes-packing text-brand-cyan"></i> Picking List & Seriales</h4>
                        <div class="bg-slate-50 rounded-[2rem] border border-gray-100 overflow-hidden" id="modal-items-list-responsive"></div>
                    </div>
                </div>
            </div>
            <div class="p-8 bg-slate-50 border-t border-gray-100 flex flex-col md:flex-row justify-between items-center gap-6">
                <div class="flex gap-10 text-right md:text-left">
                    <div><p class="text-[9px] font-black text-brand-black uppercase tracking-widest">Subtotal</p><p id="modal-order-subtotal" class="text-sm font-bold text-brand-black">---</p></div>
                    <div><p class="text-[9px] font-black text-brand-cyan uppercase tracking-widest">Envío</p><p id="modal-order-shipping" class="text-sm font-bold text-brand-cyan">---</p></div>
                    <div class="pl-8 border-l border-gray-200"><p class="text-[9px] font-black text-brand-black uppercase tracking-widest">Total Neto</p><h4 id="modal-order-total" class="text-3xl font-black text-brand-black leading-none">---</h4></div>
                </div>
                <div class="flex items-center gap-4 w-full md:w-auto justify-end">
                    <div id="modal-footer-msg" class="text-xs font-bold uppercase tracking-widest hidden"></div>
                    <div id="modal-footer-actions" class="flex gap-3 w-full md:w-auto hidden">
                        <button id="btn-save-alistado" onclick="window.saveAlistamiento(() => window.switchTab('ACTIONABLE'))" class="flex-1 md:flex-none bg-brand-black text-white px-8 py-4 rounded-xl font-black uppercase text-[10px] tracking-widest hover:bg-brand-cyan hover:text-brand-black transition-all shadow-xl">Guardar Alistamiento</button>
                        <button id="btn-set-despachado" onclick="window.openDispatchModal()" class="flex-1 md:flex-none bg-green-500 text-white px-8 py-4 rounded-xl font-black uppercase text-[10px] tracking-widest hover:bg-green-600 transition-all shadow-xl"><i class="fa-solid fa-truck-fast mr-2"></i> Marcar Despachado</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="dispatch-modal" class="fixed inset-0 z-[80] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/70 backdrop-blur-sm" onclick="document.getElementById('dispatch-modal').classList.add('hidden')"></div>
        <div class="relative bg-white w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl text-center">
            <h3 class="text-xl font-black text-brand-black uppercase mb-6">Confirmar Envío</h3>
            <div class="space-y-4 mb-8 text-left">
                <select id="dispatch-carrier" class="w-full bg-slate-50 border border-gray-200 rounded-xl p-3 text-sm font-bold outline-none text-brand-black"><option value="">Transportadora...</option><option value="Servientrega">Servientrega</option><option value="Interrapidisimo">Interrapidísimo</option><option value="Envía">Envía</option><option value="Coordinadora">Coordinadora</option></select>
                <input type="text" id="dispatch-tracking" placeholder="Número de Guía" class="w-full bg-slate-50 border border-gray-200 rounded-xl p-3 text-sm font-mono font-bold outline-none text-brand-black">
            </div>
            <button id="btn-confirm-dispatch" onclick="window.confirmDispatch(() => window.switchTab('ACTIONABLE'))" class="w-full bg-green-500 text-white font-black py-4 rounded-xl shadow-lg uppercase text-xs tracking-widest hover:bg-green-600 transition">Confirmar y Enviar</button>
        </div>
    </div>

    <script type="module">
        import '../js/admin-guard.js';
        import { db, collection, getDocs, orderBy, query, limit, auth, doc, getDoc, updateDoc, addDoc, where } from '../js/firebase-init.js';
        import { loadAdminSidebar } from '../js/admin-ui.js';
        // NUEVOS MODULOS
        import { initManualSale, openManualSaleModal } from '../js/manual-sale.js';
        import '../js/order-actions.js'; // Carga las funciones globales (view, print, etc.)

        loadAdminSidebar();

        // Init Venta Manual
        initManualSale(() => { window.switchTab('ACTIONABLE'); });
        document.getElementById('btn-open-manual').onclick = openManualSaleModal;

        const tableBody = document.getElementById('orders-table-body');
        let currentFilter = 'ACTIONABLE';

        window.switchTab = (tabName) => {
            currentFilter = tabName;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            if(tabName === 'ACTIONABLE') document.getElementById('tab-actionable').classList.add('active');
            if(tabName === 'WAITING') document.getElementById('tab-waiting').classList.add('active');
            if(tabName === 'DISPATCHED') document.getElementById('tab-dispatched').classList.add('active');
            if(tabName === 'FAILED') document.getElementById('tab-failed').classList.add('active');
            if(tabName === 'ALL') document.getElementById('tab-all').classList.add('active');
            fetchOrders();
        };

        async function fetchOrders() {
            if (!tableBody) return;
            tableBody.innerHTML = `<tr><td colspan="7" class="p-8 text-center"><i class="fa-solid fa-circle-notch fa-spin text-brand-cyan"></i> Cargando...</td></tr>`;

            try {
                const configSnap = await getDoc(doc(db, "config", "shipping"));
                const cutoffTimeStr = configSnap.exists() ? (configSnap.data().cutoffTime || "14:00") : "14:00";
                
                const now = new Date();
                const [hours, minutes] = cutoffTimeStr.split(':').map(Number);
                const cutoffDateToday = new Date(now);
                cutoffDateToday.setHours(hours, minutes, 0, 0);

                let q;
                const ordersRef = collection(db, "orders");

                if (currentFilter === 'ACTIONABLE') {
                    q = query(ordersRef, where("status", "in", ["PAGADO", "PENDIENTE", "ALISTADO"]), orderBy("createdAt", "desc"));
                } else if (currentFilter === 'WAITING') {
                    q = query(ordersRef, where("status", "==", "PENDIENTE_PAGO"), orderBy("createdAt", "desc"));
                } else if (currentFilter === 'DISPATCHED') {
                    q = query(ordersRef, where("status", "==", "DESPACHADO"), orderBy("createdAt", "desc"), limit(50));
                } else if (currentFilter === 'FAILED') {
                    q = query(ordersRef, where("status", "in", ["CANCELADO", "RECHAZADO"]), orderBy("createdAt", "desc"), limit(50));
                } else {
                    q = query(ordersRef, orderBy("createdAt", "desc"), limit(50));
                }

                const snapshot = await getDocs(q);
                tableBody.innerHTML = "";

                if (snapshot.empty) {
                    tableBody.innerHTML = `<tr><td colspan="7" class="p-10 text-center text-xs text-brand-black font-bold uppercase">No se encontraron pedidos.</td></tr>`;
                    return;
                }

                if (currentFilter === 'ACTIONABLE') {
                    const todayOrders = [];
                    const tomorrowOrders = [];

                    snapshot.forEach(d => {
                        const o = d.data();
                        const orderDate = o.createdAt?.toDate ? o.createdAt.toDate() : new Date();
                        const isToday = orderDate.toDateString() === now.toDateString();
                        
                        if (isToday && orderDate > cutoffDateToday) { tomorrowOrders.push({ id: d.id, ...o }); } 
                        else { todayOrders.push({ id: d.id, ...o }); }
                    });

                    if (todayOrders.length > 0) {
                        tableBody.innerHTML += `<tr class="bg-green-50/50 border-b border-green-100"><td colspan="7" class="py-4 px-8"><div class="flex items-center gap-3 text-green-700"><div class="p-1.5 bg-green-100 rounded-lg"><i class="fa-solid fa-truck-fast text-xs"></i></div><span class="text-[10px] font-black uppercase tracking-widest">Prioridad: Despachar Hoy (Antes de ${cutoffTimeStr})</span></div></td></tr>`;
                        todayOrders.forEach(o => renderRow(o));
                    }
                    if (tomorrowOrders.length > 0) {
                        tableBody.innerHTML += `<tr class="bg-blue-50/50 border-b border-blue-100"><td colspan="7" class="py-4 px-8"><div class="flex items-center gap-3 text-blue-700"><div class="p-1.5 bg-blue-100 rounded-lg"><i class="fa-solid fa-clock text-xs"></i></div><span class="text-[10px] font-black uppercase tracking-widest">Despachar Mañana (Después de ${cutoffTimeStr})</span></div></td></tr>`;
                        tomorrowOrders.forEach(o => renderRow(o));
                    }
                } else {
                    snapshot.forEach(d => renderRow({ id: d.id, ...d.data() }));
                }

            } catch (e) { console.error(e); }
        }

        function renderRow(o) {
            const isTienda = o.source === 'TIENDA' || o.source === 'TIENDA_WEB';
            let sClass = 'bg-gray-100 text-gray-500', sText = o.status;
            if (o.status === 'PENDIENTE') { sClass = 'bg-yellow-100 text-yellow-700 border-yellow-200'; sText = 'Por Atender'; }
            if (o.status === 'ALISTADO') { sClass = 'bg-blue-100 text-blue-700 border-blue-200'; sText = 'Alistado'; }
            if (o.status === 'PAGADO') { sClass = 'bg-red-100 text-red-600 border-red-200 animate-pulse'; sText = 'PAGADO (URGENTE)'; }
            
            let pBadge = `<span class="text-[9px] font-black uppercase text-red-500 bg-red-50 px-2 py-1 rounded border border-red-100">Cartera</span>`;
            if (o.status === 'PAGADO' || o.paymentStatus === 'PAID') {
                pBadge = `<span class="text-[9px] font-black uppercase text-green-600 bg-green-50 px-2 py-1 rounded border border-green-100"><i class="fa-solid fa-check"></i> Pagado</span>`;
            }

            const dateStr = o.createdAt?.toDate ? o.createdAt.toDate().toLocaleDateString('es-CO', {day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit'}) : '--';

            // AQUÍ: AGREGADO EL BOTÓN "FACTURAR" (AZUL)
            const invoiceBtn = o.requiresInvoice 
                ? `<span class="w-9 h-9 rounded-xl bg-blue-50 text-blue-500 border border-blue-100 flex items-center justify-center cursor-default" title="Factura Solicitada"><i class="fa-solid fa-check text-xs"></i></span>`
                : `<button onclick="window.requestInvoice('${o.id}')" title="Solicitar Factura" class="w-9 h-9 rounded-xl bg-white border border-blue-200 text-blue-500 hover:bg-blue-500 hover:text-white transition shadow-sm flex items-center justify-center"><i class="fa-solid fa-file-invoice-dollar text-xs"></i></button>`;

            tableBody.innerHTML += `
                <tr class="hover:bg-slate-50 transition border-b border-gray-50 group">
                    <td class="px-8 py-6">
                        <div class="font-mono text-[10px] text-brand-black uppercase font-bold">#${o.id.slice(0, 8)}</div>
                        <div class="text-[9px] font-bold text-brand-black mt-1">${dateStr}</div>
                    </td>
                    <td class="px-8 py-6">
                        <div class="font-black text-brand-black uppercase text-xs">${o.userName || 'Cliente'}</div>
                        <div class="text-[9px] text-brand-black font-bold">${o.phone || ''}</div>
                    </td>
                    <td class="px-8 py-6 text-center">
                        <span class="text-[8px] font-black px-2 py-0.5 rounded shadow-sm ${isTienda ? 'bg-brand-cyan text-brand-black' : 'bg-brand-black text-white'}">${isTienda ? 'WEB' : 'MANUAL'}</span>
                    </td>
                    <td class="px-8 py-6 text-center">${pBadge}</td>
                    <td class="px-8 py-6 text-center">
                        <span class="${sClass} px-3 py-1 rounded-full text-[9px] font-black uppercase border shadow-sm block w-fit mx-auto">${sText}</span>
                    </td>
                    <td class="px-8 py-6 text-right font-black text-brand-black text-sm">$${(o.total || 0).toLocaleString('es-CO')}</td>
                    <td class="px-8 py-6 text-center">
                        <div class="flex items-center justify-center gap-2">
                            <button onclick="window.viewOrderDetail('${o.id}')" title="Ver Detalle" class="w-9 h-9 rounded-xl bg-white border border-gray-200 text-brand-black hover:bg-brand-black hover:text-white transition shadow-sm flex items-center justify-center"><i class="fa-solid fa-eye text-xs"></i></button>
                            <button onclick="window.printRemission('${o.id}')" title="Imprimir Recibo" class="w-9 h-9 rounded-xl bg-white border border-red-200 text-red-500 hover:bg-red-500 hover:text-white transition shadow-sm flex items-center justify-center"><i class="fa-solid fa-file-pdf text-xs"></i></button>
                            ${invoiceBtn}
                        </div>
                    </td>
                </tr>`;
        }
        
        document.getElementById('search-input').addEventListener('keyup', function() {
            const val = this.value.toLowerCase();
            const rows = document.querySelectorAll('#orders-table-body tr');
            rows.forEach(row => { row.style.display = row.textContent.toLowerCase().includes(val) ? '' : 'none'; });
        });

        // Inicio
        fetchOrders();
    </script>
</body>
</html>