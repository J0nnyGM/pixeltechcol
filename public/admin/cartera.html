<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Cartera | PixelTech Admin</title>
    <link rel="stylesheet" href="../css/styles.css">
    <script src="https://kit.fontawesome.com/0d623ded97.js" crossorigin="anonymous"></script>
    <style> 
        .hidden { display: none !important; } 
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .tab-btn.active { background-color: #1e293b; color: white; }
    </style>
</head>

<body class="bg-gray-100 font-sans text-brand-black flex h-screen overflow-hidden">

    <div id="admin-sidebar"></div>

    <main class="flex-grow overflow-y-auto p-8 bg-slate-50 w-full custom-scroll">
        
        <header class="flex flex-col md:flex-row justify-between items-start md:items-end mb-8 gap-6">
            <div>
                <h1 class="text-3xl font-black mb-1 text-brand-black">Gestión de Cartera</h1>
                <p class="text-gray-500 text-sm">Control de Cuentas por Cobrar (Clientes) y por Pagar (Proveedores).</p>
            </div>
            <button onclick="window.openCreatePayable()" class="bg-red-50 text-red-600 border border-red-100 px-6 py-3 rounded-xl font-black text-[10px] uppercase tracking-widest hover:bg-red-600 hover:text-white transition shadow-lg flex items-center gap-2">
                <i class="fa-solid fa-file-invoice-dollar"></i> Registrar Cuenta por Pagar
            </button>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-[2rem] border border-gray-100 shadow-sm flex items-center gap-4">
                <div class="w-14 h-14 rounded-2xl bg-green-50 text-green-500 flex items-center justify-center text-2xl"><i class="fa-solid fa-hand-holding-dollar"></i></div>
                <div>
                    <p class="text-[9px] font-black text-gray-400 uppercase tracking-widest">Por Cobrar (Activos)</p>
                    <h3 class="text-2xl font-black text-brand-black" id="total-receivable">$0</h3>
                </div>
            </div>
            <div class="bg-white p-6 rounded-[2rem] border border-gray-100 shadow-sm flex items-center gap-4">
                <div class="w-14 h-14 rounded-2xl bg-red-50 text-red-500 flex items-center justify-center text-2xl"><i class="fa-solid fa-file-invoice"></i></div>
                <div>
                    <p class="text-[9px] font-black text-gray-400 uppercase tracking-widest">Por Pagar (Pasivos)</p>
                    <h3 class="text-2xl font-black text-brand-black" id="total-payable">$0</h3>
                </div>
            </div>
            <div class="bg-slate-900 p-6 rounded-[2rem] border border-slate-800 shadow-lg flex items-center gap-4 text-white">
                <div class="w-14 h-14 rounded-2xl bg-white/10 flex items-center justify-center text-2xl"><i class="fa-solid fa-scale-balanced"></i></div>
                <div>
                    <p class="text-[9px] font-black text-white/50 uppercase tracking-widest">Balance Proyectado</p>
                    <h3 class="text-2xl font-black" id="total-balance">$0</h3>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-[2.5rem] border border-gray-200 shadow-sm overflow-hidden flex flex-col h-[600px]">
            <div class="p-4 border-b border-gray-100 flex gap-2 bg-slate-50">
                <button onclick="switchTab('receivable')" class="tab-btn active px-6 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all">
                    Cuentas por Cobrar (Clientes)
                </button>
                <button onclick="switchTab('payable')" class="tab-btn px-6 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all bg-white text-gray-400 hover:text-brand-black">
                    Cuentas por Pagar (Proveedores)
                </button>
            </div>

            <div id="tab-receivable" class="flex-grow overflow-auto custom-scroll">
                <table class="w-full text-left">
                    <thead class="bg-white text-[9px] uppercase font-black text-gray-400 tracking-widest sticky top-0 z-10">
                        <tr>
                            <th class="px-8 py-4">Cliente / Orden</th>
                            <th class="px-8 py-4">Fecha</th>
                            <th class="px-8 py-4 text-right">Total</th>
                            <th class="px-8 py-4 text-right">Abonado</th>
                            <th class="px-8 py-4 text-right">Pendiente</th>
                            <th class="px-8 py-4 text-center">Acción</th>
                        </tr>
                    </thead>
                    <tbody id="list-receivable" class="divide-y divide-gray-50 text-sm font-medium text-gray-600"></tbody>
                </table>
            </div>

            <div id="tab-payable" class="flex-grow overflow-auto custom-scroll hidden">
                <table class="w-full text-left">
                    <thead class="bg-white text-[9px] uppercase font-black text-gray-400 tracking-widest sticky top-0 z-10">
                        <tr>
                            <th class="px-8 py-4">Proveedor / Concepto</th>
                            <th class="px-8 py-4">Vencimiento</th>
                            <th class="px-8 py-4 text-right">Total</th>
                            <th class="px-8 py-4 text-right">Abonado</th>
                            <th class="px-8 py-4 text-right">Pendiente</th>
                            <th class="px-8 py-4 text-center">Acción</th>
                        </tr>
                    </thead>
                    <tbody id="list-payable" class="divide-y divide-gray-50 text-sm font-medium text-gray-600"></tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="payment-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-brand-black/80 backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-md rounded-[2.5rem] shadow-2xl overflow-hidden relative animate-in fade-in zoom-in-95">
            <div class="p-8 border-b border-gray-100 flex justify-between items-center bg-slate-50">
                <div>
                    <h3 class="text-xl font-black uppercase tracking-tighter" id="pay-modal-title">Registrar Pago</h3>
                    <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest" id="pay-modal-subtitle">...</p>
                </div>
                <button onclick="closeModal('payment-modal')" class="w-8 h-8 rounded-full bg-white text-gray-400 hover:text-brand-red flex items-center justify-center transition"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <form id="payment-form" class="p-8 space-y-5">
                <input type="hidden" id="pay-doc-id">
                <input type="hidden" id="pay-doc-type"> <div class="bg-slate-50 p-4 rounded-xl text-center border border-slate-100">
                    <p class="text-[9px] font-black text-gray-400 uppercase tracking-widest">Saldo Pendiente</p>
                    <p id="pay-balance-display" class="text-3xl font-black text-brand-black tracking-tight">$0</p>
                </div>

                <div>
                    <label class="block text-[9px] font-black text-gray-400 uppercase tracking-widest mb-1">Cuenta Tesorería *</label>
                    <select id="pay-account" required class="w-full bg-slate-50 border border-gray-200 p-3 rounded-xl font-bold text-sm outline-none focus:border-brand-cyan">
                        <option value="">Cargando cuentas...</option>
                    </select>
                </div>

                <div>
                    <label class="block text-[9px] font-black text-gray-400 uppercase tracking-widest mb-1">Monto a Registrar *</label>
                    <input type="text" id="pay-amount" required placeholder="$0" class="w-full bg-white border border-gray-200 p-3 rounded-xl font-bold text-lg text-center outline-none focus:border-brand-cyan currency-input">
                </div>

                <button type="submit" class="w-full bg-brand-black text-white py-4 rounded-xl font-black text-[10px] uppercase tracking-widest hover:bg-brand-cyan hover:text-brand-black transition shadow-lg">
                    Confirmar Transacción
                </button>
            </form>
        </div>
    </div>

    <div id="create-payable-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-brand-black/80 backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-md rounded-[2.5rem] shadow-2xl overflow-hidden animate-in fade-in zoom-in-95">
            <div class="p-8 border-b border-gray-100 flex justify-between items-center">
                <h3 class="text-xl font-black uppercase tracking-tighter text-brand-red">Nueva Deuda</h3>
                <button onclick="closeModal('create-payable-modal')" class="w-8 h-8 rounded-full bg-slate-100 text-gray-400 hover:text-brand-red flex items-center justify-center transition"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <form id="create-payable-form" class="p-8 space-y-4">
                <div>
                    <label class="block text-[9px] font-black text-gray-400 uppercase tracking-widest mb-1">Proveedor / Beneficiario *</label>
                    <input type="text" id="new-pay-provider" required placeholder="Ej: Proveedor XYZ SAS" class="w-full bg-slate-50 border border-gray-200 p-3 rounded-xl font-bold text-sm outline-none">
                </div>
                <div>
                    <label class="block text-[9px] font-black text-gray-400 uppercase tracking-widest mb-1">Concepto *</label>
                    <input type="text" id="new-pay-desc" required placeholder="Ej: Compra de Mercancía #55" class="w-full bg-slate-50 border border-gray-200 p-3 rounded-xl font-bold text-sm outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[9px] font-black text-gray-400 uppercase tracking-widest mb-1">Valor Total *</label>
                        <input type="text" id="new-pay-total" required placeholder="$0" class="w-full bg-slate-50 border border-gray-200 p-3 rounded-xl font-bold text-sm outline-none currency-input">
                    </div>
                    <div>
                        <label class="block text-[9px] font-black text-gray-400 uppercase tracking-widest mb-1">Fecha Vencimiento</label>
                        <input type="date" id="new-pay-date" required class="w-full bg-slate-50 border border-gray-200 p-3 rounded-xl font-bold text-sm outline-none">
                    </div>
                </div>
                <button type="submit" class="w-full bg-red-500 text-white py-4 rounded-xl font-black text-[10px] uppercase tracking-widest hover:bg-red-600 transition shadow-lg mt-2">
                    Registrar Deuda
                </button>
            </form>
        </div>
    </div>

    <script type="module">
        import '../js/admin-guard.js'; 
        import { loadAdminSidebar } from '../js/admin-ui.js';
        import { db, collection, addDoc, updateDoc, doc, getDocs, query, where, orderBy, Timestamp, runTransaction } from '../js/firebase-init.js';

        loadAdminSidebar();

        // Variables
        let receivables = [];
        let payables = [];
        let accounts = [];

        // DOM
        const tabReceivable = document.getElementById('tab-receivable');
        const tabPayable = document.getElementById('tab-payable');
        const listReceivable = document.getElementById('list-receivable');
        const listPayable = document.getElementById('list-payable');
        const paymentModal = document.getElementById('payment-modal');
        const paymentForm = document.getElementById('payment-form');
        const accountSelect = document.getElementById('pay-account');

        // Format Currency Input
        document.querySelectorAll('.currency-input').forEach(input => {
            input.addEventListener('input', (e) => {
                let val = e.target.value.replace(/\D/g, "");
                if (val === "") { e.target.value = ""; return; }
                e.target.value = "$" + parseInt(val, 10).toLocaleString('es-CO');
            });
        });
        const getCleanVal = (val) => val ? parseInt(val.replace(/\D/g, ""), 10) : 0;

        // Init
        async function init() {
            await loadAccounts();
            await loadReceivables();
            await loadPayables();
            calculateTotals();
        }

        // 1. Cargar Cuentas (Tesorería)
        async function loadAccounts() {
            const q = query(collection(db, "accounts"), orderBy("name", "asc"));
            const snap = await getDocs(q);
            accountSelect.innerHTML = '<option value="">Seleccione Cuenta...</option>';
            snap.forEach(d => {
                accounts.push({ id: d.id, ...d.data() });
                accountSelect.innerHTML += `<option value="${d.id}">${d.data().name}</option>`;
            });
        }

        // 2. Cargar Por Cobrar (Clientes - Orders)
        async function loadReceivables() {
            // Buscamos órdenes que NO estén pagadas ni canceladas
            // Firestore no permite != en múltiples campos fácilmente, así que filtramos en cliente
            const q = query(collection(db, "orders"), orderBy("createdAt", "desc"));
            const snap = await getDocs(q);
            receivables = [];
            listReceivable.innerHTML = "";

            snap.forEach(d => {
                const o = { id: d.id, ...d.data() };
                const paid = o.amountPaid || 0;
                const total = o.total || 0;
                const balance = total - paid;

                // Filtro Lógico: Deuda > 0 y No Cancelada
                if (balance > 0 && o.status !== 'CANCELADO' && o.paymentStatus !== 'PAID') {
                    receivables.push({ ...o, balance });
                    
                    listReceivable.innerHTML += `
                        <tr class="hover:bg-slate-50 transition border-b border-gray-50 last:border-0">
                            <td class="px-8 py-4">
                                <p class="font-black text-xs uppercase text-brand-black">${o.userName || 'Cliente'}</p>
                                <p class="text-[9px] text-gray-400 font-mono">#${o.id.slice(0,6)}</p>
                            </td>
                            <td class="px-8 py-4 text-xs font-bold text-gray-500">${o.createdAt?.toDate().toLocaleDateString('es-CO')}</td>
                            <td class="px-8 py-4 text-right font-bold text-gray-400">$${total.toLocaleString('es-CO')}</td>
                            <td class="px-8 py-4 text-right font-bold text-green-600">$${paid.toLocaleString('es-CO')}</td>
                            <td class="px-8 py-4 text-right font-black text-brand-black">$${balance.toLocaleString('es-CO')}</td>
                            <td class="px-8 py-4 text-center">
                                <button onclick="window.openPayModal('${o.id}', 'order', ${balance})" class="bg-green-50 text-green-600 border border-green-100 px-4 py-2 rounded-lg text-[9px] font-black uppercase hover:bg-green-500 hover:text-white transition shadow-sm">
                                    Cobrar
                                </button>
                            </td>
                        </tr>
                    `;
                }
            });
            if(receivables.length === 0) listReceivable.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-gray-400 text-xs font-bold uppercase">No hay cuentas por cobrar</td></tr>`;
        }

        // 3. Cargar Por Pagar (Proveedores - Payables)
        async function loadPayables() {
            const q = query(collection(db, "payables"), where("status", "==", "PENDING"), orderBy("dueDate", "asc"));
            const snap = await getDocs(q);
            payables = [];
            listPayable.innerHTML = "";

            snap.forEach(d => {
                const p = { id: d.id, ...d.data() };
                const paid = p.amountPaid || 0;
                const total = p.total || 0;
                const balance = total - paid;

                payables.push({ ...p, balance });

                listPayable.innerHTML += `
                    <tr class="hover:bg-slate-50 transition border-b border-gray-50 last:border-0">
                        <td class="px-8 py-4">
                            <p class="font-black text-xs uppercase text-brand-black">${p.provider}</p>
                            <p class="text-[9px] text-gray-400">${p.description}</p>
                        </td>
                        <td class="px-8 py-4 text-xs font-bold text-red-400">${p.dueDate ? new Date(p.dueDate).toLocaleDateString('es-CO') : 'N/A'}</td>
                        <td class="px-8 py-4 text-right font-bold text-gray-400">$${total.toLocaleString('es-CO')}</td>
                        <td class="px-8 py-4 text-right font-bold text-green-600">$${paid.toLocaleString('es-CO')}</td>
                        <td class="px-8 py-4 text-right font-black text-brand-black">$${balance.toLocaleString('es-CO')}</td>
                        <td class="px-8 py-4 text-center">
                            <button onclick="window.openPayModal('${p.id}', 'payable', ${balance})" class="bg-red-50 text-red-600 border border-red-100 px-4 py-2 rounded-lg text-[9px] font-black uppercase hover:bg-red-500 hover:text-white transition shadow-sm">
                                Pagar
                            </button>
                        </td>
                    </tr>
                `;
            });
            if(payables.length === 0) listPayable.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-gray-400 text-xs font-bold uppercase">No hay cuentas por pagar</td></tr>`;
        }

        // 4. Modal de Pago (Unificado)
        window.openPayModal = (id, type, balance) => {
            document.getElementById('pay-doc-id').value = id;
            document.getElementById('pay-doc-type').value = type;
            document.getElementById('pay-balance-display').textContent = `$${balance.toLocaleString('es-CO')}`;
            document.getElementById('pay-amount').value = ""; // Reset
            
            const title = document.getElementById('pay-modal-title');
            const sub = document.getElementById('pay-modal-subtitle');
            
            if (type === 'order') {
                title.innerHTML = `Registrar <span class="text-green-500">Ingreso</span>`;
                sub.textContent = "Abono de Cliente a Cartera";
            } else {
                title.innerHTML = `Registrar <span class="text-red-500">Egreso</span>`;
                sub.textContent = "Pago a Proveedor / Deuda";
            }
            
            paymentModal.classList.remove('hidden');
        };

        // 5. Procesar Pago (TRANSACCIÓN CONTABLE)
        paymentForm.onsubmit = async (e) => {
            e.preventDefault();
            const btn = paymentForm.querySelector('button');
            btn.disabled = true; btn.innerText = "Procesando...";

            const docId = document.getElementById('pay-doc-id').value;
            const type = document.getElementById('pay-doc-type').value; // 'order' or 'payable'
            const accId = accountSelect.value;
            const amount = getCleanVal(document.getElementById('pay-amount').value);

            if(!accId) { alert("Seleccione cuenta"); btn.disabled=false; return; }
            if(amount <= 0) { alert("Monto inválido"); btn.disabled=false; return; }

            try {
                await runTransaction(db, async (t) => {
                    // A. Leer Cuenta
                    const accRef = doc(db, "accounts", accId);
                    const accDoc = await t.get(accRef);
                    if(!accDoc.exists()) throw "Cuenta no existe";
                    const accData = accDoc.data();

                    // B. Leer Documento Deuda
                    const collectionName = type === 'order' ? 'orders' : 'payables';
                    const docRef = doc(db, collectionName, docId);
                    const docSnap = await t.get(docRef);
                    if(!docSnap.exists()) throw "Documento no existe";
                    const docData = docSnap.data();

                    // C. Cálculos
                    const currentPaid = docData.amountPaid || 0;
                    const total = docData.total || 0;
                    const balance = total - currentPaid;

                    if (amount > balance) throw `El monto excede la deuda ($${balance.toLocaleString()})`;

                    // D. Actualizar Saldo Banco
                    let newAccBalance = accData.balance;
                    if (type === 'order') {
                        newAccBalance += amount; // Entra dinero (Cobro)
                    } else {
                        newAccBalance -= amount; // Sale dinero (Pago)
                    }
                    t.update(accRef, { balance: newAccBalance });

                    // E. Actualizar Documento
                    const newPaid = currentPaid + amount;
                    const updates = { 
                        amountPaid: newPaid,
                        lastPaymentDate: Timestamp.now()
                    };
                    
                    if (type === 'order') {
                        updates.paymentStatus = (newPaid >= total) ? 'PAID' : 'PARTIAL';
                    } else {
                        updates.status = (newPaid >= total) ? 'PAID' : 'PENDING';
                    }
                    t.update(docRef, updates);

                    // F. Crear Registro en Historial (Expenses)
                    const expRef = doc(collection(db, "expenses"));
                    const isIncome = type === 'order';
                    
                    t.set(expRef, {
                        description: isIncome ? `Cobro Cliente: ${docData.userName || 'Cliente'}` : `Pago Proveedor: ${docData.provider || 'Proveedor'}`,
                        amount: isIncome ? -amount : amount, // Negativo si es ingreso para que treasury lo pinte verde (lógica anterior) O positivo con categoría
                        category: isIncome ? "Ingreso Ventas" : "Pago Proveedores",
                        paymentMethod: accData.name, // Link a treasury
                        date: Timestamp.now(),
                        createdAt: Timestamp.now(),
                        supplierName: isIncome ? (docData.userName || "Cliente") : (docData.provider || "Proveedor")
                    });
                });

                alert("✅ Transacción Exitosa");
                window.closeModal('payment-modal');
                init(); // Recargar todo

            } catch (error) {
                console.error(error);
                alert("Error: " + error.message || error);
            } finally {
                btn.disabled = false; btn.innerText = "Confirmar Transacción";
            }
        };

        // 6. Registrar Nueva Cuenta por Pagar (Manual)
        document.getElementById('create-payable-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            btn.disabled = true; 

            const provider = document.getElementById('new-pay-provider').value;
            const desc = document.getElementById('new-pay-desc').value;
            const total = getCleanVal(document.getElementById('new-pay-total').value);
            const date = document.getElementById('new-pay-date').value;

            try {
                await addDoc(collection(db, "payables"), {
                    provider, description: desc, total, dueDate: date,
                    amountPaid: 0, status: 'PENDING', createdAt: Timestamp.now()
                });
                alert("✅ Deuda registrada");
                window.closeModal('create-payable-modal');
                init();
            } catch (e) { alert("Error: " + e.message); }
            finally { btn.disabled = false; }
        };

        // UI Helpers
        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.classList.remove('active', 'bg-slate-900', 'text-white');
                b.classList.add('bg-white', 'text-gray-400');
            });
            event.target.classList.add('active', 'bg-slate-900', 'text-white');
            event.target.classList.remove('bg-white', 'text-gray-400');

            document.getElementById('tab-receivable').classList.add('hidden');
            document.getElementById('tab-payable').classList.add('hidden');
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
        };

        function calculateTotals() {
            const totalRec = receivables.reduce((sum, i) => sum + i.balance, 0);
            const totalPay = payables.reduce((sum, i) => sum + i.balance, 0);
            const bal = totalRec - totalPay;

            document.getElementById('total-receivable').textContent = `$${totalRec.toLocaleString('es-CO')}`;
            document.getElementById('total-payable').textContent = `$${totalPay.toLocaleString('es-CO')}`;
            document.getElementById('total-balance').textContent = `$${bal.toLocaleString('es-CO')}`;
            document.getElementById('total-balance').className = `text-2xl font-black ${bal >= 0 ? 'text-green-400' : 'text-red-400'}`;
        }

        window.openCreatePayable = () => document.getElementById('create-payable-modal').classList.remove('hidden');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');

        init();
    </script>
</body>
</html>