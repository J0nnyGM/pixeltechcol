<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Aliados | PixelTech Admin</title>
    <link rel="stylesheet" href="../css/styles.css">
    <script src="https://kit.fontawesome.com/0d623ded97.js" crossorigin="anonymous"></script>
    <style>
        .hidden { display: none; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #00AEC7; border-radius: 10px; }
        
        /* Tarjetas con borde definido y diseño CRM */
        .supplier-card { 
            @apply bg-white border-2 border-gray-100 p-7 rounded-[2.5rem] shadow-sm hover:shadow-2xl hover:border-brand-cyan/40 transition-all duration-500 relative overflow-hidden cursor-pointer; 
        }
        
        /* Tabs Premium */
        .tabs-container {
            @apply flex bg-white p-1.5 rounded-[2rem] border border-gray-100 shadow-sm inline-flex;
        }

        .tab-btn { 
            @apply flex items-center gap-2 px-8 py-3.5 rounded-2xl font-black text-[10px] uppercase tracking-widest transition-all duration-300; 
        }

        .tab-btn.active { 
            @apply bg-brand-black text-white shadow-xl shadow-brand-black/20; 
        }
        
        .tab-btn.active i { @apply text-brand-cyan; }

        .tab-btn:not(.active) { 
            @apply text-gray-400 hover:bg-slate-50 hover:text-brand-black; 
        }
    </style>
</head>

<body class="bg-slate-50 font-sans text-brand-black flex h-screen overflow-hidden">

    <div id="admin-sidebar"></div>

    <main class="flex-grow overflow-y-auto relative custom-scroll">
        <header class="bg-white/80 backdrop-blur-md border-b border-gray-100 px-8 py-5 flex justify-between items-center sticky top-0 z-20">
            <h2 class="font-black text-gray-400 text-[10px] uppercase tracking-[0.4em]">Ecosistema de Proveedores</h2>
            <div class="flex items-center gap-4">
                <button onclick="openSupplierModal()" class="bg-brand-cyan text-brand-black px-8 py-3 rounded-2xl font-black text-[10px] uppercase tracking-widest hover:bg-brand-black hover:text-white transition-all shadow-xl shadow-cyan-500/10">
                    <i class="fa-solid fa-user-plus mr-2"></i> Nuevo Proveedor
                </button>
                <div class="w-10 h-10 bg-brand-black text-brand-cyan rounded-2xl flex items-center justify-center font-bold shadow-lg">
                    <i class="fa-solid fa-handshake"></i>
                </div>
            </div>
        </header>

        <div class="p-8 max-w-7xl mx-auto">
            <div class="flex flex-col lg:flex-row justify-between items-start lg:items-end mb-12 gap-8 text-left">
                <div>
                    <h1 class="text-5xl font-black text-brand-black tracking-tighter uppercase leading-none">Gestión de <br><span class="text-brand-cyan">Aliados</span></h1>
                    <p class="text-gray-400 text-sm font-bold mt-4 tracking-wide italic">Ecosistema de datos y auditoría de inventario.</p>
                </div>
                
                <div class="tabs-container">
                    <button class="tab-btn active" data-tab="directory">
                        <i class="fa-solid fa-address-book"></i> Directorio
                    </button>
                    <button class="tab-btn" data-tab="purchases">
                        <i class="fa-solid fa-receipt"></i> Historial Global
                    </button>
                </div>
            </div>

            <div id="search-container" class="mb-10 text-left">
                <div class="relative max-w-md">
                    <input type="text" id="search-input" placeholder="Buscar por nombre o NIT..." class="w-full bg-white border border-gray-100 p-4 rounded-2xl text-sm font-bold outline-none focus:ring-2 focus:ring-brand-cyan/20 transition-all">
                    <i class="fa-solid fa-magnifying-glass absolute right-5 top-1/2 -translate-y-1/2 text-gray-300"></i>
                </div>
            </div>

            <div id="section-directory" class="tab-content">
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8" id="suppliers-grid"></div>
            </div>

            <div id="section-purchases" class="tab-content hidden">
                <div class="bg-white rounded-[3rem] shadow-2xl border border-gray-100 overflow-hidden">
                    <div class="overflow-x-auto text-left">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-50/50 text-[10px] uppercase font-black text-gray-400 tracking-widest border-b">
                                <tr>
                                    <th class="px-8 py-6">Fecha</th>
                                    <th class="px-8 py-6">Proveedor</th>
                                    <th class="px-8 py-6">Resumen de Equipos</th>
                                    <th class="px-8 py-6 text-right">Inversión</th>
                                    <th class="px-8 py-6 text-center">Detalle</th>
                                </tr>
                            </thead>
                            <tbody id="purchases-table-body" class="divide-y divide-gray-50"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="loading-state" class="p-20 text-center hidden">
                <i class="fa-solid fa-circle-notch fa-spin text-4xl text-brand-cyan"></i>
            </div>
        </div>
    </main>

    <div id="supplier-modal" class="fixed inset-0 z-[90] hidden transition-all duration-300">
        <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-md" onclick="closeModal()"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4">
                <div class="relative bg-white rounded-[3rem] shadow-2xl w-full max-w-2xl p-10 flex flex-col text-left">
                    <div class="flex justify-between items-center mb-8 border-b pb-4">
                        <h3 class="text-2xl font-black tracking-tighter uppercase" id="modal-title">Ficha de <span class="text-gray-300">Proveedor</span></h3>
                        <button onclick="closeModal()" class="text-gray-400 hover:text-brand-red bg-gray-50 p-2 rounded-xl transition"><i class="fa-solid fa-xmark text-xl"></i></button>
                    </div>
                    
                    <form id="supplier-form" class="grid grid-cols-2 gap-4">
                        <input type="hidden" id="s-id-field">
                        
                        <div class="col-span-2 bg-slate-50 p-3 rounded-xl border">
                            <label class="text-[8px] font-black text-gray-400 uppercase">Nombre de la Empresa</label>
                            <input type="text" id="s-name" required class="w-full bg-transparent outline-none font-bold text-sm" placeholder="Ej: Distribuidora Global">
                        </div>
                        <div class="bg-slate-50 p-3 rounded-xl border">
                            <label class="text-[8px] font-black text-gray-400 uppercase">NIT / Identificación</label>
                            <input type="text" id="s-nit" required class="w-full bg-transparent outline-none font-bold text-sm" placeholder="900.000.000-1">
                        </div>
                        <div class="bg-slate-50 p-3 rounded-xl border">
                            <label class="text-[8px] font-black text-gray-400 uppercase">Persona de Contacto</label>
                            <input type="text" id="s-contact" class="w-full bg-transparent outline-none font-bold text-sm" placeholder="Nombre del asesor">
                        </div>
                        <div class="bg-slate-50 p-3 rounded-xl border">
                            <label class="text-[8px] font-black text-gray-400 uppercase">WhatsApp</label>
                            <input type="text" id="s-phone" required class="w-full bg-transparent outline-none font-bold text-sm" placeholder="573000000000">
                        </div>
                        <div class="bg-slate-50 p-3 rounded-xl border">
                            <label class="text-[8px] font-black text-gray-400 uppercase">Correo Electrónico</label>
                            <input type="email" id="s-email" class="w-full bg-transparent outline-none font-bold text-sm" placeholder="aliado@correo.com">
                        </div>
                        
                        <div class="col-span-2 border-t pt-4"><p class="text-[10px] font-black uppercase tracking-widest mb-3">Información Bancaria</p></div>
                        <div class="bg-slate-50 p-3 rounded-xl border"><label class="text-[8px] font-black text-gray-400 uppercase">Banco</label><input type="text" id="s-bank" class="w-full bg-transparent outline-none font-bold text-sm"></div>
                        <div class="bg-slate-50 p-3 rounded-xl border"><label class="text-[8px] font-black text-gray-400 uppercase">Tipo Cuenta</label><select id="s-acc-type" class="w-full bg-transparent outline-none font-bold text-sm"><option value="Ahorros">Ahorros</option><option value="Corriente">Corriente</option></select></div>
                        <div class="col-span-2 bg-slate-50 p-3 rounded-xl border"><label class="text-[8px] font-black text-gray-400 uppercase">Número Cuenta</label><input type="text" id="s-acc-num" class="w-full bg-transparent outline-none font-bold text-sm"></div>
                        
                        <div class="col-span-2 border-t pt-4 grid grid-cols-2 gap-4">
                            <div><label class="text-[8px] font-black text-gray-400 uppercase block mb-1">Cargar RUT</label><input type="file" id="s-rut-file" class="text-[10px]"></div>
                            <div><label class="text-[8px] font-black text-gray-400 uppercase block mb-1">Cargar QR Pago</label><input type="file" id="s-qr-file" class="text-[10px]"></div>
                        </div>

                        <button type="submit" class="col-span-2 bg-brand-black text-white font-black py-5 rounded-2xl shadow-xl uppercase text-xs tracking-widest hover:bg-brand-cyan transition-all mt-6">Guardar Aliado</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, collection, getDocs, getDoc, addDoc, updateDoc, doc, deleteDoc, orderBy, query, where } from '../js/firebase-init.js';
        import { loadAdminSidebar } from '../js/admin-ui.js';

        loadAdminSidebar();

        const grid = document.getElementById('suppliers-grid');
        const purchasesTable = document.getElementById('purchases-table-body');
        const loading = document.getElementById('loading-state');
        const supplierModal = document.getElementById('supplier-modal');
        const supplierForm = document.getElementById('supplier-form');
        const searchInput = document.getElementById('search-input');

        let allSuppliers = [];

        // Helper para mapear items con color y capacidad
        function formatItemsWithVariants(items) {
            return items.map(i => {
                let detail = `${i.quantity}x ${i.name}`;
                const extras = [];
                if (i.color) extras.push(i.color.toUpperCase());
                if (i.capacity) extras.push(i.capacity.toUpperCase());
                if (extras.length > 0) detail += ` (${extras.join(' / ')})`;
                return detail;
            }).join(', ');
        }

        // --- DIRECTORIO ---
        async function fetchSuppliers() {
            loading.classList.remove('hidden');
            grid.innerHTML = "";
            try {
                const snap = await getDocs(query(collection(db, "suppliers"), orderBy("name", "asc")));
                allSuppliers = [];
                snap.forEach(d => {
                    const s = d.data();
                    allSuppliers.push({ id: d.id, ...s });
                });
                renderSupplierGrid(allSuppliers);
            } catch (e) { console.error(e); }
            loading.classList.add('hidden');
        }

        function renderSupplierGrid(data) {
            grid.innerHTML = "";
            data.forEach(s => {
                const card = document.createElement('div');
                card.className = "supplier-card group";
                // REDIRECCIÓN A PÁGINA DE DETALLE
                card.onclick = () => { window.location.href = `supplier-detail.html?id=${s.id}`; };
                
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-6">
                        <div class="w-14 h-14 bg-slate-900 text-brand-cyan rounded-2xl flex items-center justify-center text-2xl shadow-xl group-hover:scale-110 transition-transform"><i class="fa-solid fa-building-circle-check"></i></div>
                        <div class="flex gap-2">
                            <button onclick="event.stopPropagation(); openSupplierModal('${s.id}')" class="text-gray-200 hover:text-brand-cyan transition"><i class="fa-solid fa-pen"></i></button>
                            <button onclick="event.stopPropagation(); deleteSupplier('${s.id}')" class="text-gray-200 hover:text-brand-red transition"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    </div>
                    <h3 class="font-black text-brand-black uppercase tracking-tighter text-xl mb-1 leading-tight">${s.name}</h3>
                    <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-8">NIT: ${s.nit || '---'}</p>
                    <div class="grid grid-cols-2 gap-4 border-t border-gray-50 pt-6">
                        <div><p class="text-[8px] font-black text-gray-400 uppercase mb-1">Inversión Neta</p><p class="text-sm font-black text-brand-black">$${(s.totalInvested || 0).toLocaleString('es-CO')}</p></div>
                        <div class="text-right"><p class="text-[8px] font-black text-gray-400 uppercase mb-1">Pedidos</p><p class="text-sm font-black text-brand-black">${s.ordersCount || 0}</p></div>
                    </div>
                    <div class="absolute bottom-0 left-0 w-full h-1.5 bg-brand-cyan scale-x-0 group-hover:scale-x-100 transition-transform duration-500"></div>
                `;
                grid.appendChild(card);
            });
        }

        // --- HISTORIAL GLOBAL ---
        async function fetchPurchases() {
            loading.classList.remove('hidden');
            purchasesTable.innerHTML = "";
            try {
                const snap = await getDocs(query(collection(db, "purchases"), orderBy("createdAt", "desc")));
                snap.forEach(d => {
                    const p = d.data();
                    const itemsPreview = formatItemsWithVariants(p.items); 
                    purchasesTable.innerHTML += `
                        <tr class="hover:bg-slate-50 transition-colors border-b border-gray-50">
                            <td class="px-8 py-6 font-bold text-gray-400 text-xs">${p.createdAt?.toDate().toLocaleDateString()}</td>
                            <td class="px-8 py-6 font-black text-brand-black text-xs uppercase">${p.supplierName}</td>
                            <td class="px-8 py-6 text-[10px] text-gray-500 italic uppercase font-bold">${itemsPreview}</td>
                            <td class="px-8 py-6 text-right font-black text-brand-black">$${(p.totalCost || 0).toLocaleString('es-CO')}</td>
                            <td class="px-8 py-6 text-center">
                                <a href="supplier-detail.html?id=${p.supplierId}" class="w-10 h-10 rounded-2xl bg-brand-black text-brand-cyan hover:bg-brand-cyan hover:text-brand-black transition-all flex items-center justify-center mx-auto shadow-lg"><i class="fa-solid fa-address-card"></i></a>
                            </td>
                        </tr>`;
                });
            } catch (e) { console.error(e); }
            loading.classList.add('hidden');
        }

        // --- BUSCADOR ---
        searchInput.oninput = (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = allSuppliers.filter(s => s.name.toLowerCase().includes(term) || (s.nit && s.nit.includes(term)));
            renderSupplierGrid(filtered);
        };

        // --- TABS ---
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.onclick = (e) => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                const target = e.target.tagName === 'I' ? e.target.parentElement : e.target;
                target.classList.add('active');
                document.getElementById(`section-${target.dataset.tab}`).classList.remove('hidden');
                if(target.dataset.tab === 'purchases') fetchPurchases();
                else fetchSuppliers();
            };
        });

        // --- CRUD MODAL ---
        window.openSupplierModal = async (id = null) => {
            supplierForm.reset();
            document.getElementById('s-id-field').value = id || "";
            document.getElementById('modal-title').textContent = id ? "Editar Aliado" : "Ficha de Proveedor";
            
            if (id) {
                const snap = await getDoc(doc(db, "suppliers", id));
                const s = snap.data();
                document.getElementById('s-name').value = s.name;
                document.getElementById('s-nit').value = s.nit;
                document.getElementById('s-contact').value = s.contactName || "";
                document.getElementById('s-phone').value = s.phone;
                document.getElementById('s-email').value = s.email || "";
                document.getElementById('s-bank').value = s.bankName || "";
                document.getElementById('s-acc-num').value = s.accNum || "";
                document.getElementById('s-acc-type').value = s.accType || "Ahorros";
            }
            supplierModal.classList.remove('hidden');
        };

        supplierForm.onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('s-id-field').value;
            const data = {
                name: document.getElementById('s-name').value,
                nit: document.getElementById('s-nit').value,
                contactName: document.getElementById('s-contact').value,
                phone: document.getElementById('s-phone').value,
                email: document.getElementById('s-email').value,
                bankName: document.getElementById('s-bank').value,
                accNum: document.getElementById('s-acc-num').value,
                accType: document.getElementById('s-acc-type').value,
                updatedAt: new Date()
            };

            try {
                if (id) await updateDoc(doc(db, "suppliers", id), data);
                else await addDoc(collection(db, "suppliers"), { ...data, totalInvested: 0, ordersCount: 0, createdAt: new Date() });
                alert("✅ Guardado correctamente");
                closeModal(); fetchSuppliers();
            } catch (err) { alert(err.message); }
        };

        window.deleteSupplier = async (id) => { if(confirm("¿Eliminar aliado comercial?")) { await deleteDoc(doc(db, "suppliers", id)); fetchSuppliers(); } };
        window.closeModal = () => { supplierModal.classList.add('hidden'); supplierForm.reset(); };

        fetchSuppliers();
    </script>
</body>
</html>